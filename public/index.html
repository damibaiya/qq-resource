<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸å°ç«™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥æœ€æ–°ç‰ˆ Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script>
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (!isMobile) { 
            // é¿å…é˜»å¡æ¸²æŸ“ï¼Œä½¿ç”¨ CSS ç±»æ§åˆ¶
            document.documentElement.classList.add('is-pc');
        }
    </script>
    <style>
        [x-cloak] { display: none !important; } 
        body { background: #f0f9ff; color: #334155; font-family: sans-serif; }
        
        /* PC ç«¯æ‹¦æˆªé®ç½© */
        #pc-block { display: none; }
        .is-pc body > nav, .is-pc body > main, .is-pc body > footer { display: none; }
        .is-pc #pc-block { 
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #f0f9ff; z-index: 9999; justify-content: center; align-items: center; 
            flex-direction: column; text-align: center;
        }

        /* Toast åŠ¨ç”» */
        .toast-enter { transform: translateY(-20px); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-leave { transform: translateY(0); opacity: 1; }
        .toast-leave-active { transform: translateY(-20px); opacity: 0; transition: all 0.3s ease-in; }
    </style>
</head>
<body x-data="app()" @scroll.window="handleScroll">

    <!-- PC æ‹¦æˆªæç¤º -->
    <div id="pc-block">
        <div class="text-6xl mb-4">ğŸš«</div>
        <h1 class="text-xl font-bold">ä»…æ”¯æŒç§»åŠ¨ç«¯è®¿é—®</h1>
        <p class="text-gray-500 mt-2">è¯·ä½¿ç”¨æ‰‹æœºæˆ–å¹³æ¿è®¾å¤‡æµè§ˆ</p>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white/95 backdrop-blur shadow-sm sticky top-0 z-40 border-b border-blue-100">
        <div class="max-w-5xl mx-auto px-4 h-14 flex justify-between items-center">
            <a href="/" class="text-xl font-bold text-blue-600 tracking-wider flex items-center gap-2"><span>ğŸ³</span> è“é²¸å°ç«™</a>
            <div>
                <!-- æœªç™»å½•çŠ¶æ€ -->
                <template x-if="!user">
                    <button @click="openModal('login')" class="text-blue-500 font-bold px-3 py-1.5 rounded-lg border border-blue-100 text-sm hover:bg-blue-50">ç™»å½•/æ³¨å†Œ</button>
                </template>
                <!-- å·²ç™»å½•çŠ¶æ€ (ç”¨æˆ·ä¸­å¿ƒ) -->
                <template x-if="user">
                    <button @click="showUserCenter" class="flex items-center gap-2 px-2 py-1 rounded-full border border-transparent hover:border-blue-100 transition relative">
                        <div class="w-7 h-7 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs" x-text="user.username ? user.username[0].toUpperCase() : 'U'"></div>
                        <div x-show="unreadCount > 0" class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>
                        <div class="text-xs text-blue-500 font-medium">ğŸ”‘ <span x-text="quota.remaining"></span></div>
                    </button>
                </template>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-4">
        <!-- æœç´¢æ  -->
        <div class="flex gap-2 mb-4">
            <div class="relative flex-1">
                <input type="text" x-model="searchQ" @keyup.enter="resetAndSearch" placeholder="ğŸ” æœæ ‡é¢˜/æ—¥æœŸ..." class="w-full pl-3 pr-10 py-2.5 rounded-xl border border-blue-100 text-sm outline-none focus:ring-2 focus:ring-blue-300 shadow-sm bg-white">
                <button @click="resetAndSearch" class="absolute right-1 top-1 bottom-1 px-3 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-200 transition">æœç´¢</button>
            </div>
            <div class="relative shrink-0">
                <select x-model="sortType" @change="resetAndSearch" class="h-full px-2 rounded-xl border border-blue-100 text-xs outline-none bg-white text-gray-600 shadow-sm appearance-none pr-6">
                    <option value="date-desc">ğŸ“… æœ€æ–°</option>
                    <option value="date-asc">ğŸ“… æœ€æ—§</option>
                    <option value="title-asc">ğŸ”¤ A-Z</option>
                </select>
                <div class="absolute right-1.5 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 text-[10px]">â–¼</div>
            </div>
        </div>

        <!-- å¯¼èˆªåŒºåŸŸ (3ä¸ªæŒ‰é’®) -->
        <div class="grid grid-cols-12 gap-3 mb-6 relative z-30">
            
            <!-- 1. åˆ†ç±»ç­›é€‰æŒ‰é’® (å·¦ä¾§) -->
            <div class="col-span-4 relative" @click.away="showCatMenu = false">
                <!-- æŒ‰é’®æ–‡å­—ç”± getCategoryLabel() åŠ¨æ€ç”Ÿæˆ -->
                <button @click="showCatMenu = !showCatMenu" class="w-full h-12 rounded-xl bg-white border border-blue-200 text-blue-600 font-bold text-sm shadow-sm flex items-center justify-between px-3 hover:bg-blue-50 transition">
                    <span class="truncate" x-text="getCategoryLabel()"></span>
                    <span class="text-xs transition-transform duration-200" :class="showCatMenu ? 'rotate-180' : ''">â–¼</span>
                </button>

                <!-- ä¸‹æ‹‰èœå• -->
                <div x-show="showCatMenu" x-cloak x-transition class="absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-blue-100 z-30 overflow-hidden py-1">
                    <button @click="filterCat(null); showCatMenu=false" class="w-full text-left px-4 py-3 text-sm hover:bg-blue-50 flex justify-between items-center" :class="!currentCat?'text-blue-600 font-bold bg-blue-50':''">
                        <span>ğŸ“‚ å…¨éƒ¨</span>
                        <span x-show="!currentCat">âœ“</span>
                    </button>
                    <!-- å¾ªç¯æ˜¾ç¤ºåˆ†ç±» (ç»¼è‰ºã€ç”µè§†å‰§ã€åŠ¨æ¼«) -->
                    <template x-for="cat in categories" :key="cat.id">
                        <button @click="filterCat(cat.id); showCatMenu=false" class="w-full text-left px-4 py-3 text-sm hover:bg-blue-50 flex justify-between items-center border-t border-gray-50" :class="currentCat===cat.id?'text-blue-600 font-bold bg-blue-50':''">
                            <span x-text="cat.name"></span>
                            <span x-show="currentCat===cat.id">âœ“</span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- 2. ç•ªç»„ç´¢å¼• -->
            <button @click="showTagWall('ç•ªç»„')" class="col-span-4 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 text-white font-bold text-sm shadow-md hover:shadow-lg hover:scale-[1.02] transition-all flex items-center justify-center gap-1 active:scale-95" :class="currentTagType==='ç•ªç»„' ? 'ring-2 ring-purple-300 ring-offset-2' : ''">
                <span>ğŸ“º</span> ç•ªç»„
            </button>

            <!-- 3. è‰ºäººç´¢å¼• -->
            <button @click="showTagWall('è‰ºäºº')" class="col-span-4 h-12 rounded-xl bg-gradient-to-br from-pink-500 to-rose-600 text-white font-bold text-sm shadow-md hover:shadow-lg hover:scale-[1.02] transition-all flex items-center justify-center gap-1 active:scale-95" :class="currentTagType==='è‰ºäºº' ? 'ring-2 ring-pink-300 ring-offset-2' : ''">
                <span>ğŸ¤</span> è‰ºäºº
            </button>
        </div>

        <!-- è§†å›¾1: æ ‡ç­¾å›¾ç‰‡å¢™ -->
        <div x-show="viewMode === 'tags'" x-cloak class="animate-fade-in mb-6">
            <div class="flex justify-between items-center mb-3 px-1">
                <span class="text-xs font-bold text-gray-500" x-text="currentTagType + ' ç´¢å¼•'"></span>
                <button @click="resetFilters" class="text-xs text-blue-500">âœ• å…³é—­ç´¢å¼•</button>
            </div>
            <div class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                <template x-for="t in tags" :key="t.id">
                    <div @click="filterByTagId(t.id)" class="bg-white rounded-xl p-2 shadow-sm border border-gray-100 text-center cursor-pointer hover:border-blue-400 hover:shadow-md transition group" :class="currentTagId===t.id?'ring-2 ring-blue-400 border-transparent':''">
                        <div class="aspect-square w-full rounded-lg mb-2 bg-gray-50 overflow-hidden relative">
                            <img x-show="t.image_url" :src="t.image_url" loading="lazy" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                            <div x-show="!t.image_url" class="absolute inset-0 flex items-center justify-center text-gray-300 text-xs">No Img</div>
                        </div>
                        <div class="text-xs font-bold truncate text-gray-700 group-hover:text-blue-600" x-text="t.name"></div>
                    </div>
                </template>
            </div>
            <div x-show="tags.length === 0" class="text-center py-12 text-gray-400 text-xs bg-white rounded-xl border border-dashed">æš‚æ— ç›¸å…³æ ‡ç­¾</div>
        </div>

        <!-- è§†å›¾2: æ–‡ç« åˆ—è¡¨ -->
        <div x-show="viewMode === 'list'" class="space-y-4 min-h-[300px] animate-fade-in">
            <!-- æ ‡ç­¾ç­›é€‰æç¤ºæ¡ -->
            <div x-show="currentTagId" x-cloak class="flex justify-between items-center bg-blue-50 px-3 py-2 rounded-lg text-xs text-blue-600 border border-blue-100 shadow-sm">
                <span class="font-bold">ğŸ·ï¸ æ­£åœ¨æŸ¥çœ‹æ ‡ç­¾å†…å®¹</span>
                <button @click="showTagWall(currentTagType)" class="underline hover:text-blue-800">è¿”å›ç´¢å¼•</button>
            </div>

            <template x-for="item in processedResources" :key="item.id">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-blue-50 hover:shadow-lg hover:-translate-y-0.5 transition duration-300 cursor-pointer" @click="openDetail(item)">
                    <!-- æ ‡ç­¾è¡Œ -->
                    <div class="flex flex-wrap gap-1.5 mb-2.5">
                        <span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-md font-bold" x-text="getCatName(item.category_id)"></span>
                        <template x-for="t in item.tags" :key="t.name">
                            <span class="text-[10px] px-2 py-0.5 rounded-md text-white font-medium shadow-sm" :class="t.type==='ç•ªç»„'?'bg-purple-400':'bg-pink-400'" x-text="t.name"></span>
                        </template>
                    </div>
                    <h3 class="text-base font-bold text-slate-800 line-clamp-2 mb-2.5 leading-snug" x-text="item.title"></h3>
                    <div class="text-xs text-gray-400 flex items-center justify-between pt-2 border-t border-gray-50">
                        <span class="flex items-center gap-1">ğŸ“… <span x-text="item.custom_date || 'æ—¥æœŸä¸è¯¦'"></span></span>
                        <div class="flex gap-4">
                            <span class="flex items-center gap-1">ğŸ’¬ <span x-text="item.comment_count"></span></span>
                            <span class="flex items-center gap-1 text-pink-400">â¤ï¸ <span x-text="item.like_count"></span></span>
                        </div>
                    </div>
                </div>
            </template>
            
            <div class="py-6 text-center">
                <button x-show="!isLoading && hasMore" @click="loadMore" class="text-blue-500 text-xs border border-blue-200 px-6 py-2 rounded-full hover:bg-blue-50 hover:shadow-md transition">ç‚¹å‡»åŠ è½½æ›´å¤š</button>
                <div x-show="isLoading" class="text-blue-500 text-xs animate-pulse">ğŸš€ æ­£åœ¨åŠ è½½ç²¾å½©å†…å®¹...</div>
                <div x-show="!hasMore && processedResources.length > 0" class="text-gray-300 text-xs mt-4">â€” æˆ‘æ˜¯æœ‰åº•çº¿çš„ â€”</div>
                <div x-show="!isLoading && processedResources.length === 0" class="text-gray-400 text-sm py-10 flex flex-col items-center">
                    <span class="text-3xl mb-2">ğŸƒ</span>
                    <span>æš‚æ— ç›¸å…³å†…å®¹</span>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-8 text-xs text-gray-400 border-t border-blue-50 mt-8">
        &copy; è“é²¸å°ç«™ Resource
    </footer>

    <!-- Toast ç»„ä»¶ -->
    <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-3 pointer-events-none" id="toast-container"></div>
    <script>window.showToast=(m,t='info')=>{const c=document.getElementById('toast-container'),e=document.createElement('div');let s='bg-slate-800 text-white shadow-xl',i='ğŸ“¢';if(t==='success'){s='bg-emerald-500 text-white shadow-emerald-200/50';i='âœ…'}if(t==='error'){s='bg-rose-500 text-white shadow-rose-200/50';i='âŒ'}if(t==='warn'){s='bg-amber-400 text-white shadow-amber-200/50';i='âš ï¸'}e.className=`${s} px-6 py-3 rounded-full text-sm font-bold flex items-center gap-2 pointer-events-auto toast-enter min-w-[200px] justify-center`;e.innerHTML=`<span>${i}</span><span>${m}</span>`;c.appendChild(e);requestAnimationFrame(()=>e.classList.add('toast-enter-active'));setTimeout(()=>{e.classList.remove('toast-enter-active');e.classList.add('toast-leave-active');setTimeout(()=>e.remove(),300)},t==='error'?4000:3000)};window.alert=(m)=>showToast(m,'warn');</script>

    <!-- ç”¨æˆ·ä¸­å¿ƒå¼¹çª— -->
    <div x-show="showCenter" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-2xl relative transform transition-all scale-100" @click.away="showCenter=false">
            <button @click="showCenter=false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 text-xl">&times;</button>
            <div class="flex flex-col items-center mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-bold mb-3 shadow-inner" x-text="user.username ? user.username[0].toUpperCase() : 'U'"></div>
                <h2 class="text-xl font-bold text-gray-800" x-text="user.username"></h2>
                <p class="text-sm text-gray-500" x-text="user.email"></p>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 p-5 rounded-xl mb-4 shadow-sm">
                <div class="flex justify-between items-end mb-2"><span class="text-sm text-gray-600 font-bold">ä»Šæ—¥å‰©ä½™é’¥åŒ™</span><span class="text-2xl font-bold text-blue-600 leading-none" x-text="quota.remaining"></span></div>
                <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-600 h-2 rounded-full" :style="'width: ' + ((quota.remaining/quota.total)*100) + '%'"></div></div>
                <div class="text-xs text-right text-gray-400 mt-1">æ€»é…é¢: <span x-text="quota.total"></span></div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-xl text-xs text-yellow-800 border border-yellow-100 mb-6 leading-relaxed">
                <strong>âœ¨ è¿ç»­è§£é”å¥–åŠ±è§„åˆ™ï¼š</strong><br>â€¢ 1-10å¤©: æ¬¡æ—¥+1 (ä¸Šé™3)<br>â€¢ 11-20å¤©: ä¸Šé™4<br>â€¢ >20å¤©: ä¸Šé™5<br>â€¢ ä¸­æ–­åˆ™é‡ç½®ä¸º1
            </div>
            <div class="space-y-3">
                <button @click="openChat" class="w-full py-2.5 border border-blue-200 text-blue-600 rounded-xl hover:bg-blue-50 font-bold transition flex items-center justify-center gap-2">ğŸ“© ç§ä¿¡ç®¡ç†å‘˜ <span x-show="unreadCount > 0" class="bg-red-500 text-white text-[10px] px-1.5 rounded-full" x-text="unreadCount"></span></button>
                <button @click="showDonate=true;showCenter=false" class="w-full py-2.5 border border-pink-200 text-pink-600 rounded-xl hover:bg-pink-50 font-bold transition">â¤ï¸ æèµ æ”¯æŒ</button>
                <button @click="logout" class="w-full py-2.5 bg-gray-100 text-gray-500 rounded-xl hover:bg-red-50 hover:text-red-500 font-bold transition">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- æèµ å¼¹çª— -->
    <div x-show="showDonate" x-cloak class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50" @click.self="showDonate=false">
        <div class="bg-white p-4 rounded-2xl w-[70%] text-center shadow-2xl transform transition-all">
            <h3 class="font-bold text-lg mb-2 text-pink-500">æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼</h3>
            <p class="text-xs text-gray-400 mb-4">ä¿å­˜å›¾ç‰‡æ‰«ç </p>
            <img src="https://img.xn--xit.de5.net/code.png" class="w-full rounded-xl mb-4 shadow-lg">
            <button @click="showDonate=false" class="w-full py-2 bg-gray-100 rounded-lg text-sm font-bold hover:bg-gray-200 transition">å…³é—­</button>
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div x-show="detailItem" x-cloak class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh] relative animate-fade-in-up" @click.away="detailItem=null">
            <div class="p-5 border-b bg-white rounded-t-2xl z-10 shrink-0 flex justify-between items-start">
                <div><h2 class="text-lg font-bold text-slate-800 leading-snug" x-text="detailItem?.title"></h2><div class="flex flex-wrap gap-2 mt-2"><template x-if="detailItem?.tags"><template x-for="t in detailItem.tags" :key="t.name"><span class="text-[10px] px-2 py-0.5 rounded-full text-white font-bold" :class="t.type==='ç•ªç»„'?'bg-purple-400':'bg-pink-400'" x-text="t.name"></span></template></template></div></div><button @click="detailItem=null" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div class="p-5 overflow-y-auto custom-scrollbar">
                <div x-show="isLocked" class="mb-6 p-4 bg-blue-50 rounded-xl text-center border border-blue-100"><p class="text-sm text-blue-800 mb-2 font-bold">ğŸ”’ æ­¤å¸–åŒ…å«å—é™å†…å®¹</p><button @click="unlockAll(detailItem.id)" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition">æ¶ˆè€— 1 æŠŠé’¥åŒ™è§£é”å…¨éƒ¨</button></div>
                <div class="space-y-4 mb-8"><template x-for="(block, idx) in detailItem?.content" :key="idx"><div class="break-words text-sm"><template x-if="block.type === 'text'"><p class="whitespace-pre-wrap text-gray-700 leading-relaxed" x-text="block.value"></p></template><template x-if="block.type === 'image'"><img :src="block.isLockedMask ? 'https://via.placeholder.com/400x200?text=LOCKED' : block.value" loading="lazy" class="rounded-lg w-full" :class="block.isLockedMask?'opacity-50 blur-sm':''"></template><template x-if="block.type === 'link'"><div class="p-3 bg-gray-50 rounded-lg border border-gray-100 flex flex-col gap-1"><div class="flex items-center gap-2"><span class="text-lg">ğŸ”—</span><span class="font-bold text-gray-600 text-xs" x-text="block.linkType || 'å¤¸å…‹é“¾æ¥'"></span></div><template x-if="block.isLockedMask"><span class="text-gray-400 text-xs italic">*** å†…å®¹å·²éšè— ***</span></template><template x-if="!block.isLockedMask"><div class="text-xs break-all font-mono select-all bg-white p-1 rounded border" x-text="block.value"></div><a :href="block.value" target="_blank" class="text-xs text-blue-500 hover:underline text-right mt-1">è·³è½¬ &rarr;</a></template></div></template></div></template></div>
                <div class="border-t pt-4"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-700 text-sm">è¯„è®ºåŒº</h3><button @click="like(detailItem.id)" class="text-pink-500 text-xs font-bold bg-pink-50 px-3 py-1 rounded-full">â¤ï¸ <span x-text="detailItem?.like_count||0"></span></button></div><div class="flex gap-2 mb-4"><input type="text" x-model="newComment" @keyup.enter="postComment(detailItem.id)" placeholder="åˆ†äº«..." class="flex-1 border border-gray-200 bg-gray-50 p-3 rounded-xl text-sm outline-none"><button @click="postComment(detailItem.id)" class="bg-blue-600 text-white px-4 rounded-lg text-xs font-bold">å‘é€</button></div><div class="space-y-3"><template x-for="c in comments" :key="c.id"><div class="bg-gray-50 p-3 rounded-xl text-xs"><div class="flex justify-between text-gray-400 mb-1"><span class="font-bold text-blue-600" x-text="c.username"></span><span x-text="new Date(c.created_at).toLocaleString()"></span></div><div class="text-gray-700" x-text="c.content"></div></div></template></div></div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œ æ¨¡æ€æ¡† -->
    <div x-show="modalMode" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative">
            <button @click="modalMode = null" class="absolute top-4 right-4 text-gray-300 text-xl">&times;</button>
            <div x-show="modalMode === 'login'"><h2 class="text-xl font-bold text-blue-600 mb-4 text-center">ç™»å½•</h2><div class="space-y-3"><input type="text" x-model="form.loginId" placeholder="QQé‚®ç®± / ç”¨æˆ·å" class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none"><div class="relative"><input :type="showPwd?'text':'password'" x-model="form.password" placeholder="å¯†ç " class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none"><button @click="showPwd=!showPwd" class="absolute right-3 top-2.5 text-xs text-gray-400" x-text="showPwd?'ğŸ™ˆ':'ğŸ‘ï¸'"></button></div><button @click="doLogin" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-sm">ç«‹å³ç™»å½•</button><div class="flex justify-between text-xs text-gray-500 px-1"><button @click="modalMode = 'register'">æ³¨å†Œè´¦å·</button><button @click="modalMode = 'reset'">æ‰¾å›å¯†ç </button></div></div></div>
            <div x-show="modalMode === 'register'"><h2 class="text-xl font-bold text-blue-600 mb-4 text-center">æ³¨å†Œ</h2><div class="space-y-3"><input type="email" x-model="form.email" placeholder="QQé‚®ç®±" class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none"><div class="flex gap-2"><input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none"><button @click="sendCode('register')" :disabled="timer>0" class="w-20 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold" x-text="timer>0?timer:'å‘é€'"></button></div><input type="text" x-model="form.username" placeholder="è®¾ç½®ç”¨æˆ·å" class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none"><div class="relative"><input :type="showPwd?'text':'password'" x-model="form.password" placeholder="è®¾ç½®å¯†ç " class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none"><button @click="showPwd=!showPwd" class="absolute right-2 top-2 text-xs" x-text="showPwd?'ğŸ™ˆ':'ğŸ‘ï¸'"></button></div><input :type="showPwd?'text':'password'" x-model="form.confirmPassword" placeholder="ç¡®è®¤å¯†ç " class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none"><button @click="doRegister" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-sm mt-2">æ³¨å†Œå¹¶ç™»å½•</button><div class="text-center text-xs text-gray-500"><button @click="modalMode='login'">å»ç™»å½•</button></div></div></div>
            <div x-show="modalMode === 'reset'"><h2 class="text-xl font-bold mb-4 text-center">é‡ç½®å¯†ç </h2><div class="space-y-3"><input type="email" x-model="form.email" placeholder="é‚®ç®±" class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none"><div class="flex gap-2"><input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none"><button @click="sendCode('reset')" :disabled="timer>0" class="w-20 bg-blue-100 text-blue-600 text-xs rounded-lg font-bold" x-text="timer>0?timer:'å‘é€'"></button></div><input type="password" x-model="form.newPassword" placeholder="æ–°å¯†ç " class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none"><button @click="doReset" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold">ç¡®è®¤</button><div class="text-center text-xs text-gray-500"><button @click="modalMode='login'">è¿”å›</button></div></div></div>
            <div x-show="modalMode === 'message'"><div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="font-bold text-blue-600">ç§ä¿¡ç®¡ç†å‘˜</h2></div><div class="h-64 overflow-y-auto bg-gray-50 p-3 rounded-lg mb-3 custom-scrollbar space-y-2" id="chatBox"><template x-for="msg in messages" :key="msg.id"><div class="flex flex-col" :class="msg.sender==='user'?'items-end':'items-start'"><div class="max-w-[85%] p-2 rounded-lg text-xs" :class="msg.sender==='user'?'bg-blue-500 text-white rounded-tr-none':'bg-white border rounded-tl-none'"><span x-text="msg.content"></span></div></div></template><div x-show="messages.length===0" class="text-center text-gray-400 text-xs pt-10">æš‚æ— æ¶ˆæ¯</div></div><div class="flex gap-2"><input type="text" x-model="msgInput" class="flex-1 border p-2 rounded-lg text-sm outline-none" placeholder="è¾“å…¥..." @keyup.enter="sendMsg"><button @click="sendMsg" class="bg-blue-600 text-white px-4 rounded-lg text-xs font-bold">å‘é€</button></div></div>
        </div>
    </div>

    <script>
        function app() {
            return {
                user: JSON.parse(localStorage.getItem('user') || 'null'),
                token: localStorage.getItem('token') || '',
                categories: [], resources: [], tags: [], 
                viewMode: 'list', 
                currentCat: null, currentTagType: null, currentTagId: null,
                quota: {total:0, remaining:0}, unreadCount: 0,
                modalMode: null, showCenter: false, showDonate: false, detailItem: null,
                form: { loginId:'', email:'', username:'', password:'', confirmPassword:'', code:'' },
                searchQ: '', newComment: '', comments: [], msgInput: '', messages: [], timer:0, sortType: 'date-desc', showPwd: false,
                page: 1, hasMore: true, isLoading: false, showCatMenu: false,

                // ã€æ ¸å¿ƒä¿®å¤ã€‘ç¡®ä¿ categories åŠ è½½å‰ä¸ä¼šæŠ¥é”™
                getCategoryLabel() {
                    if (this.currentCat && this.categories.length > 0) {
                        const c = this.categories.find(c => c.id == this.currentCat);
                        return c ? `ğŸ“‚ ${c.name}` : 'ğŸ“‚ ç±»åˆ«';
                    }
                    return 'ğŸ“‚ ç±»åˆ«';
                },

                get processedResources() {
                    let list = this.resources.map(r => ({...r}));
                    return list.sort((a, b) => {
                        const getDate = (item) => {
                            if (item.custom_date) {
                                const s = item.custom_date.replace(/å¹´/g, '/').replace(/æœˆ/g, '/').replace(/æ—¥/g, '');
                                const d = new Date(s); if (!isNaN(d)) return d;
                            } return new Date(item.created_at);
                        };
                        if (this.sortType === 'date-desc') return getDate(b) - getDate(a);
                        if (this.sortType === 'date-asc') return getDate(a) - getDate(b);
                        if (this.sortType === 'title-asc') return a.title.localeCompare(b.title, 'zh');
                        return 0;
                    });
                },
                get isLocked() { if(!this.detailItem) return false; return this.detailItem.content.some(b => b.isLockedMask); },

                async init() { 
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (!isMobile && document.getElementById('pc-block')) document.getElementById('pc-block').style.display = 'flex';
                    if(this.token) this.refreshUser(); 
                    this.doSearch(); 
                    window.addEventListener('scroll', this.handleScroll.bind(this));
                },

                handleScroll() {
                    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                    if (scrollTop + clientHeight >= scrollHeight - 100 && !this.isLoading && this.hasMore) {
                        this.loadMore();
                    }
                },

                async doSearch() { return this.fetchResources(true); },
                resetAndSearch() { this.doSearch(); },
                async loadMore() { this.page++; await this.fetchResources(false); },

                async fetchResources(isReset) {
                    this.isLoading = true;
                    if(isReset) { this.page = 1; this.resources = []; this.hasMore = true; }

                    let url = `/api/public/home?page=${this.page}&q=${this.searchQ}`;
                    if(this.currentCat) url += `&catId=${this.currentCat}`; 
                    if(this.currentTagId) url += `&tagId=${this.currentTagId}`; 
                    
                    try {
                        const res = await fetch(url);
                        const data = await res.json();
                        // åˆå§‹åŒ–åˆ†ç±»æ•°æ®
                        if(this.page === 1) this.categories = data.categories || [];
                        
                        if(data.resources && data.resources.length > 0) {
                            const newItems = data.resources.filter(n => !this.resources.find(o => o.id === n.id));
                            this.resources = [...this.resources, ...newItems];
                        }
                        this.hasMore = data.hasMore;
                    } catch(e) { console.error(e); }
                    this.isLoading = false;
                },

                resetFilters() { this.currentCat = null; this.currentTagType = null; this.currentTagId = null; this.viewMode = 'list'; this.doSearch(); },
                
                filterCat(id) { 
                    this.currentCat = id; 
                    this.currentTagType = null; 
                    this.currentTagId = null; 
                    this.viewMode = 'list'; 
                    this.doSearch(); 
                },
                
                async showTagWall(type) {
                    this.currentTagType = type; this.currentCat = null; this.currentTagId = null; this.viewMode = 'tags';
                    const res = await fetch(`/api/public/tags?type=${type}`); this.tags = await res.json();
                },
                filterByTagId(id) { this.currentTagId = id; this.viewMode = 'list'; this.doSearch(); },

                async refreshUser() { const res = await fetch('/api/user/info', { headers: {'Authorization': `Bearer ${this.token}`} }); if(res.ok) { const data = await res.json(); this.user = data.user; this.quota = data.quota; this.unreadCount = data.unread_count||0; localStorage.setItem('user', JSON.stringify(data.user)); } else this.logout(); },
                showUserCenter() { this.refreshUser(); this.showCenter = true; },
                openModal(mode) { this.modalMode = mode; this.form = {loginId:'', email:'', username:'', password:'', confirmPassword:'', code:''}; this.showPwd=false; },
                
                // === ç§ä¿¡ç›¸å…³ ===
                async openChat() { 
                    this.showCenter=false; 
                    this.modalMode='message'; 
                    const res = await fetch('/api/user/messages', { headers: {'Authorization': `Bearer ${this.token}`} }); 
                    if(res.ok) { 
                        this.messages = await res.json(); 
                        this.$nextTick(() => {
                            const box = document.getElementById('chatBox');
                            if(box) box.scrollTop = box.scrollHeight;
                        }); 
                    } 
                },
                async sendMsg() { 
                    if(!this.msgInput) return; 
                    const res = await fetch('/api/user/message/send', {method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:JSON.stringify({content:this.msgInput})}); 
                    if(res.ok) { 
                        this.msgInput = ''; 
                        // é‡æ–°åŠ è½½æ¶ˆæ¯
                        const r = await fetch('/api/user/messages', { headers: {'Authorization': `Bearer ${this.token}`} }); 
                        this.messages = await r.json();
                        this.$nextTick(() => document.getElementById('chatBox').scrollTop = 9999);
                    } else showToast('å‘é€å¤±è´¥','error'); 
                },

                // è®¤è¯ç›¸å…³
                async sendCode(type) { if(!this.form.email) return showToast('é‚®ç®±å¿…å¡«','warn'); const res = await fetch('/api/auth/send-code', {method:'POST', body:JSON.stringify({email:this.form.email, type})}); if(res.ok){ showToast('ğŸš€ éªŒè¯ç å·²å‘é€','success'); this.timer=60; setInterval(()=>this.timer>0&&this.timer--,1000); } else showToast((await res.json()).error,'error'); },
                async doRegister() { if(this.form.password !== this.form.confirmPassword) return showToast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´','warn'); const res = await fetch('/api/auth/register', {method:'POST', body:JSON.stringify(this.form)}); const data = await res.json(); if(res.ok) { showToast('ğŸ‰ æ³¨å†ŒæˆåŠŸ','success'); this.loginSuccess(data); } else showToast(data.error,'error'); },
                async doLogin() { const res = await fetch('/api/auth/login', {method:'POST', body:JSON.stringify({...this.form, isAdmin:false})}); const data = await res.json(); if(res.ok) { showToast('ğŸ‘‹ æ¬¢è¿å›æ¥','success'); this.loginSuccess(data); } else showToast(data.error,'error'); },
                async doReset() { const res = await fetch('/api/auth/reset-password', {method:'POST', body:JSON.stringify(this.form)}); if(res.ok) { showToast('âœ… å¯†ç é‡ç½®æˆåŠŸ','success'); this.modalMode='login'; } else showToast((await res.json()).error,'error'); },
                loginSuccess(data) { this.user=data.user; this.token=data.token; localStorage.setItem('user', JSON.stringify(data.user)); localStorage.setItem('token', data.token); this.modalMode=null; this.refreshUser(); },
                logout() { localStorage.clear(); location.reload(); },

                async unlockAll(resourceId) { if(!this.user) { showToast('è¯·å…ˆç™»å½•','warn'); return this.modalMode = 'login'; } if(!confirm('æ¶ˆè€— 1 æŠŠé’¥åŒ™è§£é”å…¨éƒ¨?')) return; const res = await fetch('/api/resource/unlock', { method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:JSON.stringify({resourceId}) }); const data = await res.json(); if(res.ok) { showToast('ğŸ”“ è§£é”æˆåŠŸ','success'); const fullContent = data.fullContent; this.detailItem.content = this.detailItem.content.map((b, idx) => { if(b.isLockedMask) return { ...b, value: fullContent[idx].value, isLockedMask: false }; return b; }); this.refreshUser(); } else showToast(data.error,'error'); },
                async openDetail(item) { this.detailItem = JSON.parse(JSON.stringify(item)); const res = await fetch(`/api/resource/comments/${item.id}`); this.comments = await res.json(); },
                async postComment(rid) { if(!this.user) { showToast('è¯·å…ˆç™»å½•','warn'); return this.modalMode = 'login'; } if(!this.newComment) return; await fetch('/api/resource/comment', {method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:JSON.stringify({resourceId:rid, content:this.newComment})}); this.newComment = ''; showToast('è¯„è®ºå·²å‘é€','success'); this.openDetail(this.detailItem); },
                async like(rid) { if(!this.user) { showToast('è¯·å…ˆç™»å½•','warn'); return this.modalMode = 'login'; } await fetch('/api/resource/like', {method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:JSON.stringify({resourceId:rid})}); this.detailItem.like_count++; showToast('â¤ï¸ ç‚¹èµæˆåŠŸ','success'); },
            }
        }
    </script>
</body>
</html>
