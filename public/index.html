<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸å°ç«™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; } 
        body { background: #f0f9ff; color: #334155; font-family: sans-serif; }
    </style>
</head>
<body x-data="app()" @scroll.window="handleScroll">
    <nav class="bg-white/95 backdrop-blur shadow-sm sticky top-0 z-40 border-b border-blue-100">
        <div class="max-w-5xl mx-auto px-4 h-14 flex justify-between items-center">
            <a href="/" class="text-xl font-bold text-blue-600 tracking-wider flex items-center gap-2"><span>ğŸ³</span> è“é²¸å°ç«™</a>
            <div>
                <template x-if="!user">
                    <button @click="openModal('login')" class="text-blue-500 font-bold px-3 py-1.5 rounded-lg border border-blue-100 text-sm">ç™»å½•/æ³¨å†Œ</button>
                </template>
                <template x-if="user">
                    <a href="/user" class="flex items-center gap-2 px-2 py-1 rounded-full border border-transparent hover:border-blue-100 transition relative">
                        <div class="w-7 h-7 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs" x-text="user.username[0].toUpperCase()"></div>
                        <div x-show="unreadCount > 0" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                        <div class="text-xs text-blue-500">ğŸ”‘ <span x-text="quota.remaining"></span></div>
                    </a>
                </template>
            </div>
        </div>
    </nav>
    <!-- ä¸­é—´å†…å®¹ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç¯‡å¹…ï¼Œè¯·ä¿ç•™åŸ index.html çš„ main, footer, è¯¦æƒ…å¼¹çª—, ç™»å½•å¼¹çª—éƒ¨åˆ† -->
    <!-- ä»¥ä¸‹åªåˆ—å‡ºä¿®æ”¹äº†ç”¨æˆ·ä¸­å¿ƒå¼¹çª—çš„éƒ¨åˆ† -->

    <!-- ç”¨æˆ·ä¸­å¿ƒå¼¹çª— -->
    <div x-show="showCenter" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-2xl relative" @click.away="showCenter=false">
            <button @click="showCenter=false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 text-xl">&times;</button>
            <div class="flex flex-col items-center mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-bold mb-3 shadow-inner" x-text="user.username ? user.username[0].toUpperCase() : 'U'"></div>
                <h2 class="text-xl font-bold text-gray-800" x-text="user.username"></h2>
                <p class="text-sm text-gray-500" x-text="user.email"></p>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 p-5 rounded-xl mb-4 shadow-sm">
                <div class="flex justify-between items-end mb-2"><span class="text-sm text-gray-600 font-bold">ä»Šæ—¥å‰©ä½™é’¥åŒ™</span><span class="text-2xl font-bold text-blue-600 leading-none" x-text="quota.remaining"></span></div>
                <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-600 h-2 rounded-full" :style="'width: ' + ((quota.remaining/quota.total)*100) + '%'"></div></div>
                <div class="text-xs text-right text-gray-400 mt-1">æ€»é…é¢: <span x-text="quota.total"></span></div>
            </div>
            <div class="space-y-3">
                <button @click="openChat" class="w-full py-2.5 border border-blue-200 text-blue-600 rounded-xl hover:bg-blue-50 font-bold transition flex items-center justify-center gap-2">
                    ğŸ“© ç§ä¿¡ç®¡ç†å‘˜ 
                    <span x-show="unreadCount > 0" class="bg-red-500 text-white text-[10px] px-1.5 rounded-full" x-text="unreadCount"></span>
                </button>
                <button @click="logout" class="w-full py-2.5 bg-gray-100 text-gray-500 rounded-xl hover:bg-red-50 hover:text-red-500 font-bold transition">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>
    
    <!-- è„šæœ¬éƒ¨åˆ† -->
    <script>
        function app() {
            return {
                user: JSON.parse(localStorage.getItem('user') || 'null'),
                token: localStorage.getItem('token') || '',
                categories: [], resources: [], tags: [], 
                viewMode: 'list', 
                currentCat: null, currentTagType: null, currentTagId: null,
                quota: {total:0, remaining:0}, unreadCount: 0, // æ–°å¢
                modalMode: null, showCenter: false, detailItem: null,
                form: { loginId:'', email:'', username:'', password:'', confirmPassword:'', code:'' },
                searchQ: '', newComment: '', comments: [], timer:0, sortType: 'date-desc', showPwd: false,
                page: 1, hasMore: true, isLoading: false,

                // ... processedResources ä¿æŒä¸å˜ ...

                async init() { 
                    if(this.token) this.refreshUser(); 
                    this.doSearch(); 
                    window.addEventListener('scroll', () => {
                        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                        if (scrollTop + clientHeight >= scrollHeight - 100 && !this.isLoading && this.hasMore) {
                            this.loadMore();
                        }
                    });
                },

                // ... æœç´¢/åˆ†é¡µé€»è¾‘ä¿æŒä¸å˜ ...

                async refreshUser() { 
                    const res = await fetch('/api/user/info', { headers: {'Authorization': `Bearer ${this.token}`} }); 
                    if(res.ok) { 
                        const data = await res.json(); 
                        this.user = data.user; 
                        this.quota = data.quota; 
                        this.unreadCount = data.unread_count || 0; // è·å–æœªè¯»æ•°
                        localStorage.setItem('user', JSON.stringify(data.user)); 
                    } else this.logout(); 
                },
                
                // ... å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ ...
            }
        }
    </script>
</body>
</html>
