<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸å°ç«™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>[x-cloak]{display:none!important} body{background:#f0f9ff; color:#334155;}</style>
</head>
<body x-data="app()">
    <!-- å¯¼èˆª -->
    <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-blue-100">
        <div class="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-blue-600 tracking-wider hover:text-blue-700">ğŸ³ è“é²¸å°ç«™</a>
            <div>
                <template x-if="!user">
                    <button @click="openModal('login')" class="text-blue-500 font-bold hover:bg-blue-50 px-4 py-2 rounded-lg transition">ç™»å½• / æ³¨å†Œ</button>
                </template>
                <template x-if="user">
                    <div class="flex items-center gap-4">
                        <button @click="showUserCenter" class="flex items-center gap-2 hover:bg-blue-50 px-2 py-1 rounded transition">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold" x-text="user.username[0].toUpperCase()"></div>
                            <div class="text-sm text-left">
                                <div class="font-bold text-gray-700" x-text="user.username"></div>
                                <div class="text-xs text-blue-500">å‰©ä½™è§£é”: <span x-text="quota.remaining"></span>æ¬¡</div>
                            </div>
                        </button>
                    </div>
                </template>
            </div>
        </div>
    </nav>

    <!-- ä¸»ä½“ -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- æœç´¢ä¸åˆ†ç±» -->
        <div class="mb-6 space-y-4">
            <div class="flex gap-2">
                <input type="text" x-model="searchQ" @keyup.enter="doSearch" placeholder="æœç´¢å¸–å­..." class="flex-1 p-3 rounded-lg border border-blue-100 shadow-sm outline-none focus:ring-2 focus:ring-blue-300">
                <button @click="doSearch" class="bg-blue-600 text-white px-6 rounded-lg font-bold hover:bg-blue-700">æœç´¢</button>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-2">
                <button @click="filterCat(null)" :class="!currentCat ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-blue-50'" class="px-4 py-1.5 rounded-full text-sm font-medium shadow-sm shrink-0">å…¨éƒ¨</button>
                <template x-for="cat in categories" :key="cat.id">
                    <button @click="filterCat(cat.id)" :class="currentCat===cat.id ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-blue-50'" class="px-4 py-1.5 rounded-full text-sm font-medium shadow-sm shrink-0" x-text="cat.name"></button>
                </template>
            </div>
        </div>

        <!-- æ–‡ç« åˆ—è¡¨ -->
        <div class="space-y-6">
            <template x-for="item in filteredResources" :key="item.id">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-50 hover:shadow-md transition cursor-pointer" @click="openDetail(item)">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-slate-800" x-text="item.title"></h3>
                        <span class="text-xs px-2 py-1 bg-gray-100 rounded text-gray-500" x-text="item.category_name || 'æœªåˆ†ç±»'"></span>
                    </div>
                    <div class="text-xs text-gray-400 mb-4 flex gap-4">
                        <span x-text="'ğŸ“… ' + (item.custom_date || 'æ—¥æœŸä¸è¯¦')"></span>
                        <span x-text="'ğŸ’¬ ' + item.comment_count"></span>
                        <span x-text="'â¤ï¸ ' + item.like_count"></span>
                    </div>
                    <div class="text-sm text-blue-500 font-bold">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… & è¯„è®º &rarr;</div>
                </div>
            </template>
            <div x-show="filteredResources.length === 0" class="text-center text-gray-400 py-10">è¿™é‡Œè¿˜æ˜¯ä¸€ç‰‡è“è‰²çš„æµ·æ´‹...</div>
        </div>
    </main>

    <!-- åº•éƒ¨ -->
    <footer class="text-center py-8 text-sm text-gray-400">
        <button @click="modalMode='contact'" class="hover:text-blue-500">è”ç³»ç®¡ç†å‘˜</button>
    </footer>

    <!-- ç”¨æˆ·ä¸­å¿ƒå¼¹çª— -->
    <div x-show="showCenter" x-cloak class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-xl relative" @click.away="showCenter=false">
            <h2 class="text-xl font-bold text-blue-600 mb-4">ç”¨æˆ·ä¸­å¿ƒ</h2>
            <div class="space-y-3 text-sm text-gray-700">
                <p><strong>ç”¨æˆ·å:</strong> <span x-text="user.username"></span></p>
                <p><strong>é‚®ç®±:</strong> <span x-text="user.email"></span></p>
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <p class="text-lg font-bold text-blue-600 mb-1">ä»Šæ—¥å‰©ä½™è§£é”: <span x-text="quota.remaining"></span> æ¬¡</p>
                    <p class="text-xs text-gray-500">æ¯æ—¥æ€»é…é¢: <span x-text="quota.total"></span> æ¬¡</p>
                </div>
                <div class="bg-yellow-50 p-3 rounded-lg text-xs text-yellow-800 border border-yellow-100">
                    <strong>âœ¨ è¿ç»­è§£é”å¥–åŠ±è§„åˆ™ï¼š</strong><br>
                    å¦‚æœæ‚¨ä»Šå¤©ä½¿ç”¨äº†é™åˆ¶è§£é”åŠŸèƒ½ï¼Œæ˜å¤©æ‚¨çš„æ¯æ—¥é¢åº¦å°† +1 (æœ€é«˜å¯è¾¾3æ¬¡)ã€‚<br>
                    å¦‚æœæŸå¤©ä¸­æ–­äº†ä½¿ç”¨ï¼Œæ¬¡æ—¥é¢åº¦å°†é‡ç½®ä¸º 1 æ¬¡ã€‚
                </div>
            </div>
            <button @click="logout" class="w-full mt-6 py-2 border border-red-200 text-red-500 rounded-lg hover:bg-red-50">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- è¯¦æƒ…/è¯„è®ºå¼¹çª— -->
    <div x-show="detailItem" x-cloak class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-xl my-8 flex flex-col max-h-[90vh]" @click.away="detailItem=null">
            <div class="p-6 border-b flex justify-between items-start sticky top-0 bg-white z-10 rounded-t-2xl">
                <div>
                    <h2 class="text-xl font-bold text-slate-800" x-text="detailItem?.title"></h2>
                    <div class="text-xs text-gray-400 mt-1" x-text="'å‘å¸ƒæ—¶é—´: ' + (detailItem?.custom_date || 'æ—¥æœŸä¸è¯¦')"></div>
                </div>
                <button @click="detailItem=null" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <!-- å†…å®¹æ¸²æŸ“ -->
                <div class="space-y-4 mb-8">
                    <template x-for="(block, idx) in detailItem?.content" :key="idx">
                        <div>
                            <template x-if="block.type === 'text'"><p class="whitespace-pre-wrap text-gray-700" x-text="block.value"></p></template>
                            <template x-if="block.type === 'image'">
                                <div class="relative group">
                                    <template x-if="block.isLockedMask">
                                        <div class="w-full h-32 bg-gray-100 flex items-center justify-center rounded-lg border-2 border-dashed border-gray-300">
                                            <button @click="unlock(detailItem.id, idx)" class="text-blue-500 font-bold hover:underline">ğŸ”’ å—é™å›¾ç‰‡ (ç‚¹å‡»æ¶ˆè€—æ¬¡æ•°è§£é”)</button>
                                        </div>
                                    </template>
                                    <template x-if="!block.isLockedMask"><img :src="block.value" class="rounded-lg max-h-96 object-cover"></template>
                                </div>
                            </template>
                            <template x-if="block.type === 'link'">
                                <div class="p-3 bg-blue-50 rounded-lg flex items-center gap-2">
                                    <span class="text-blue-400">ğŸ”—</span>
                                    <template x-if="block.isLockedMask">
                                        <button @click="unlock(detailItem.id, idx)" class="text-blue-600 font-bold hover:underline">å—é™é“¾æ¥ (ç‚¹å‡»æ¶ˆè€—æ¬¡æ•°æŸ¥çœ‹)</button>
                                    </template>
                                    <template x-if="!block.isLockedMask"><a :href="block.value" target="_blank" class="text-blue-600 hover:underline break-all" x-text="block.value"></a></template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- ç‚¹èµ -->
                <div class="flex items-center gap-4 mb-8 border-t pt-4">
                    <button @click="like(detailItem.id)" class="flex items-center gap-2 px-4 py-2 bg-pink-50 text-pink-500 rounded-full hover:bg-pink-100 transition">
                        <span>â¤ï¸</span> <span x-text="detailItem?.like_count"></span> ç‚¹èµ
                    </button>
                </div>

                <!-- è¯„è®ºåŒº -->
                <div>
                    <h3 class="font-bold text-gray-700 mb-4">è¯„è®ºåŒº</h3>
                    <div class="flex gap-2 mb-6">
                        <input type="text" x-model="newComment" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." class="flex-1 border p-2 rounded-lg text-sm">
                        <button @click="postComment(detailItem.id)" class="bg-blue-600 text-white px-4 rounded-lg text-sm">å‘é€</button>
                    </div>
                    <div class="space-y-4">
                        <template x-for="c in comments" :key="c.id">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span class="font-bold text-blue-600" x-text="c.username"></span>
                                    <span x-text="new Date(c.created_at).toLocaleString()"></span>
                                </div>
                                <div class="text-sm text-gray-700" x-text="c.content"></div>
                            </div>
                        </template>
                        <div x-show="comments.length===0" class="text-gray-400 text-xs text-center">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•/è”ç³»æ¨¡æ€æ¡† -->
    <div x-show="modalMode" x-cloak class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-xl relative">
            <button @click="modalMode = null" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500">&times;</button>
            
            <!-- ç™»å½•/æ³¨å†Œé€»è¾‘å¤ç”¨ä¹‹å‰çš„ä»£ç ï¼Œä»…å±•ç¤ºç»“æ„ -->
            <div x-show="modalMode === 'login'">
                <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">æ¬¢è¿å›æ¥</h2>
                <div class="space-y-4">
                    <input type="text" x-model="form.loginId" placeholder="QQé‚®ç®± / ç”¨æˆ·å" class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                    <input type="password" x-model="form.password" placeholder="å¯†ç " class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                    <button @click="doLogin" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">ç™»å½•</button>
                    <div class="flex justify-between text-xs text-gray-500"><button @click="modalMode='register'">æ³¨å†Œ</button><button @click="modalMode='reset'">æ‰¾å›å¯†ç </button></div>
                </div>
            </div>
            
            <div x-show="modalMode === 'register'">
                <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">æ³¨å†Œ</h2>
                <div class="space-y-3">
                    <input type="email" x-model="form.email" placeholder="QQé‚®ç®±" class="w-full p-2 bg-blue-50 rounded-lg">
                    <div class="flex gap-2"><input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-2 bg-blue-50 rounded-lg"><button @click="sendCode('register')" :disabled="timer>0" class="w-24 bg-blue-100 text-blue-600 rounded-lg text-xs" x-text="timer>0?timer:'å‘é€'"></button></div>
                    <input type="text" x-model="form.username" placeholder="ç”¨æˆ·å" class="w-full p-2 bg-blue-50 rounded-lg">
                    <input type="password" x-model="form.password" placeholder="å¯†ç " class="w-full p-2 bg-blue-50 rounded-lg">
                    <button @click="doRegister" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">æ³¨å†Œ</button>
                    <div class="text-center text-xs text-gray-500"><button @click="modalMode='login'">å»ç™»å½•</button></div>
                </div>
            </div>

            <div x-show="modalMode === 'reset'">
                <h2 class="text-xl font-bold mb-4 text-center">é‡ç½®å¯†ç </h2>
                <div class="space-y-3">
                    <input type="email" x-model="form.email" placeholder="é‚®ç®±" class="w-full p-2 bg-blue-50 rounded"><div class="flex gap-2"><input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-2 bg-blue-50 rounded"><button @click="sendCode('reset')" class="w-20 bg-blue-100 text-xs rounded">å‘é€</button></div>
                    <input type="password" x-model="form.newPassword" placeholder="æ–°å¯†ç " class="w-full p-2 bg-blue-50 rounded">
                    <button @click="doReset" class="w-full bg-blue-600 text-white py-2 rounded">ç¡®è®¤é‡ç½®</button>
                </div>
            </div>

            <!-- è”ç³»ç®¡ç†å‘˜ -->
            <div x-show="modalMode === 'contact'">
                <h2 class="text-xl font-bold text-blue-600 mb-4 text-center">è”ç³»ç®¡ç†å‘˜</h2>
                <div class="space-y-4">
                    <textarea x-model="contactMsg" placeholder="è¯·å¡«å†™æ‚¨çš„ç•™è¨€..." rows="4" class="w-full p-3 bg-blue-50 rounded-lg outline-none"></textarea>
                    <input type="text" x-model="contactInfo" placeholder="æ‚¨çš„è”ç³»æ–¹å¼(QQ/é‚®ç®±)" class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                    <button @click="sendContact" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">å‘é€ç•™è¨€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                user: JSON.parse(localStorage.getItem('user') || 'null'),
                token: localStorage.getItem('token') || '',
                categories: [], resources: [], currentCat: null, quota: {total:0, remaining:0},
                modalMode: null, showCenter: false, detailItem: null,
                form: { loginId:'', email:'', username:'', password:'', newPassword:'', code:'' },
                searchQ: '', newComment: '', comments: [], contactMsg:'', contactInfo:'', timer:0,

                get filteredResources() {
                    if(!this.currentCat) return this.resources;
                    return this.resources.filter(r => r.category_id === this.currentCat);
                },

                async init() {
                    if(this.token) this.refreshUser();
                    this.doSearch();
                },

                async doSearch() {
                    const res = await fetch(`/api/public/home?q=${this.searchQ}`);
                    const data = await res.json();
                    this.categories = data.categories;
                    this.resources = data.resources;
                },

                async refreshUser() {
                    const res = await fetch('/api/user/info', { headers: {'Authorization': `Bearer ${this.token}`} });
                    if(res.ok) {
                        const data = await res.json();
                        this.user = data.user; this.quota = data.quota;
                        localStorage.setItem('user', JSON.stringify(data.user));
                    } else this.logout();
                },

                showUserCenter() { this.refreshUser(); this.showCenter = true; },
                openModal(mode) { this.modalMode = mode; this.form = {loginId:'', email:'', username:'', password:'', newPassword:'', code:''}; },

                // éªŒè¯ç ã€ç™»å½•ã€æ³¨å†Œã€é‡ç½®é€»è¾‘ä¸ä¹‹å‰ç›¸åŒï¼Œç®€å†™ä»¥èŠ‚çœç©ºé—´
                async sendCode(type) {
                    if(!this.form.email) return alert('é‚®ç®±å¿…å¡«');
                    const res = await fetch('/api/auth/send-code', {method:'POST', body:JSON.stringify({email:this.form.email, type})});
                    if(res.ok){ alert('å‘é€æˆåŠŸ'); this.timer=60; setInterval(()=>this.timer>0&&this.timer--,1000); } else alert((await res.json()).error);
                },
                async doRegister() {
                    const res = await fetch('/api/auth/register', {method:'POST', body:JSON.stringify(this.form)});
                    const data = await res.json();
                    if(res.ok) this.loginSuccess(data); else alert(data.error);
                },
                async doLogin() {
                    const res = await fetch('/api/auth/login', {method:'POST', body:JSON.stringify({...this.form, isAdmin:false})});
                    const data = await res.json();
                    if(res.ok) this.loginSuccess(data); else alert(data.error);
                },
                async doReset() {
                    const res = await fetch('/api/auth/reset-password', {method:'POST', body:JSON.stringify(this.form)});
                    if(res.ok) { alert('é‡ç½®æˆåŠŸ'); this.modalMode='login'; } else alert((await res.json()).error);
                },
                loginSuccess(data) {
                    this.user=data.user; this.token=data.token;
                    localStorage.setItem('user', JSON.stringify(data.user)); localStorage.setItem('token', data.token);
                    this.modalMode=null; this.refreshUser();
                },
                logout() { localStorage.clear(); location.reload(); },

                // è§£é”é€»è¾‘ (å½“æ—¥é‡å¤çœ‹å…è´¹ç”±åç«¯æ§åˆ¶ï¼Œå‰ç«¯åªéœ€åˆ·æ–°block)
                async unlock(resourceId, idx) {
                    if(!this.user) return this.modalMode = 'login';
                    if(!confirm('è§£é”å°†æ¶ˆè€—æ¬¡æ•° (ä»Šæ—¥é‡å¤æŸ¥çœ‹æ­¤å†…å®¹ä¸æ¶ˆè€—)ï¼Œç¡®å®šå—ï¼Ÿ')) return;
                    const res = await fetch('/api/resource/unlock', {
                        method:'POST', headers:{'Authorization':`Bearer ${this.token}`},
                        body:JSON.stringify({resourceId, blockIndex:idx})
                    });
                    const data = await res.json();
                    if(res.ok) {
                        this.detailItem.content[idx] = {...this.detailItem.content[idx], value:data.realValue, isLockedMask:false};
                        this.refreshUser(); // æ›´æ–°å‰©ä½™æ¬¡æ•°
                    } else alert(data.error);
                },

                // è¯¦æƒ…ã€è¯„è®ºã€ç‚¹èµã€è”ç³»
                async openDetail(item) {
                    this.detailItem = item;
                    const res = await fetch(`/api/resource/comments/${item.id}`);
                    this.comments = await res.json();
                },
                async postComment(rid) {
                    if(!this.user) return this.modalMode = 'login';
                    if(!this.newComment) return;
                    await fetch('/api/resource/comment', {
                        method:'POST', headers:{'Authorization':`Bearer ${this.token}`},
                        body:JSON.stringify({resourceId:rid, content:this.newComment})
                    });
                    this.newComment = '';
                    this.openDetail(this.detailItem); // åˆ·æ–°è¯„è®º
                },
                async like(rid) {
                    if(!this.user) return this.modalMode = 'login';
                    await fetch('/api/resource/like', {method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:JSON.stringify({resourceId:rid})});
                    this.detailItem.like_count++; // ç®€å•å‰ç«¯+1ï¼Œå®é™…ä¸Šåº”è¯¥é‡æ–°æ‹‰å–
                },
                async sendContact() {
                    if(!this.contactMsg) return;
                    await fetch('/api/contact', {method:'POST', body:JSON.stringify({msg:this.contactMsg, contact:this.contactInfo})});
                    alert('ç•™è¨€å·²å‘é€ç»™ç®¡ç†å‘˜'); this.modalMode=null;
                }
            }
        }
    </script>
</body>
</html>
