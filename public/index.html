<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸å°ç«™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (!isMobile) { document.write('<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f0f9ff;color:#334155;font-weight:bold;text-align:center;"><h1>ğŸš« è“é²¸å°ç«™ä»…æ”¯æŒç§»åŠ¨ç«¯è®¿é—®</h1></div>'); document.close(); throw new Error("PC Blocked"); }
    </script>
    <style>
        [x-cloak] { display: none !important; } 
        body { background: #f0f9ff; color: #334155; font-family: sans-serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body x-data="app()">
    <nav class="bg-white/95 backdrop-blur shadow-sm sticky top-0 z-40 border-b border-blue-100">
        <div class="max-w-5xl mx-auto px-4 h-14 flex justify-between items-center">
            <a href="/" class="text-xl font-bold text-blue-600 tracking-wider flex items-center gap-2"><span>ğŸ³</span> è“é²¸å°ç«™</a>
            <div>
                <template x-if="!user">
                    <button @click="openModal('login')" class="text-blue-500 font-bold px-3 py-1.5 rounded-lg border border-blue-100 text-sm">ç™»å½•/æ³¨å†Œ</button>
                </template>
                <template x-if="user">
                    <a href="/user" class="flex items-center gap-2 px-2 py-1 rounded-full border border-transparent hover:border-blue-100 transition">
                        <div class="w-7 h-7 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs" x-text="user.username[0].toUpperCase()"></div>
                        <div class="text-xs text-blue-500">ğŸ”‘ <span x-text="quota.remaining"></span></div>
                    </a>
                </template>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-6">
        <!-- æœç´¢ä¸æ’åº -->
        <div class="flex gap-2 mb-4">
            <input type="text" x-model="searchQ" @keyup.enter="doSearch" placeholder="ğŸ” æœæ ‡é¢˜/æ—¥æœŸ..." class="flex-1 p-2.5 rounded-lg border border-blue-100 text-sm outline-none focus:ring-2 focus:ring-blue-200">
            <select x-model="sortType" class="p-2 rounded-lg border border-blue-100 text-xs outline-none bg-white">
                <option value="date-desc">ğŸ“… æ–°â†’æ—§</option><option value="date-asc">ğŸ“… æ—§â†’æ–°</option><option value="title-asc">ğŸ”¤ A-Z</option>
            </select>
        </div>

        <!-- æ ‡ç­¾ä¸åˆ†ç±»å¯¼èˆª -->
        <div class="flex flex-col gap-2 mb-4">
            <!-- å¸¸è§„åˆ†ç±» -->
            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                <button @click="filterCat(null)" :class="!currentCat && !currentTagType ? 'bg-blue-600 text-white' : 'bg-white text-gray-500 border'" class="px-4 py-1.5 rounded-full text-xs font-bold shrink-0 transition">å…¨éƒ¨</button>
                <template x-for="cat in categories" :key="cat.id">
                    <button @click="filterCat(cat.id)" :class="currentCat===cat.id ? 'bg-blue-600 text-white' : 'bg-white text-gray-500 border'" class="px-4 py-1.5 rounded-full text-xs font-bold shrink-0 transition" x-text="cat.name"></button>
                </template>
            </div>
            <!-- ç‰¹æ®Šæ ‡ç­¾åˆ†ç±» -->
            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                <button @click="filterTag('ç•ªç»„')" :class="currentTagType==='ç•ªç»„' ? 'bg-purple-600 text-white' : 'bg-purple-50 text-purple-600 border border-purple-100'" class="px-4 py-1.5 rounded-full text-xs font-bold shrink-0 transition">ğŸ“º ç•ªç»„ç´¢å¼•</button>
                <button @click="filterTag('è‰ºäºº')" :class="currentTagType==='è‰ºäºº' ? 'bg-pink-600 text-white' : 'bg-pink-50 text-pink-600 border border-pink-100'" class="px-4 py-1.5 rounded-full text-xs font-bold shrink-0 transition">ğŸ¤ è‰ºäººç´¢å¼•</button>
            </div>
        </div>

        <!-- æ ‡ç­¾å›¾ç‰‡å¢™ (ä»…åœ¨é€‰æ‹©ç•ªç»„/è‰ºäººæ—¶æ˜¾ç¤º) -->
        <div x-show="currentTagType && tags.length > 0" class="mb-6 grid grid-cols-3 sm:grid-cols-4 gap-3 animate-fade-in">
            <template x-for="t in tags" :key="t.id">
                <div @click="filterTagId(t.id)" class="bg-white rounded-lg p-2 shadow-sm border border-gray-100 text-center cursor-pointer hover:border-blue-300 transition" :class="currentTagId===t.id?'ring-2 ring-blue-400':''">
                    <img :src="t.image_url || 'https://via.placeholder.com/100?text=No+Img'" class="w-full aspect-square object-cover rounded-md mb-2 bg-gray-50">
                    <div class="text-xs font-bold truncate text-gray-700" x-text="t.name"></div>
                </div>
            </template>
        </div>

        <!-- èµ„æºåˆ—è¡¨ -->
        <div class="space-y-4 min-h-[300px]">
            <template x-for="item in processedResources" :key="item.id">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-blue-50 hover:shadow-md transition cursor-pointer" @click="openDetail(item)">
                    <!-- æ ‡ç­¾å±•ç¤º -->
                    <div class="flex flex-wrap gap-1 mb-2">
                        <span class="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded" x-text="getCatName(item.category_id)"></span>
                        <template x-for="t in item.tags" :key="t.name">
                            <span class="text-[10px] px-1.5 py-0.5 rounded text-white" :class="t.type==='ç•ªç»„'?'bg-purple-400':'bg-pink-400'" x-text="t.name"></span>
                        </template>
                    </div>
                    <h3 class="text-base font-bold text-slate-800 line-clamp-2 mb-2" x-text="item.title"></h3>
                    <div class="text-xs text-gray-400 flex items-center justify-between">
                        <span x-text="item.custom_date || 'æ—¥æœŸä¸è¯¦'"></span>
                        <div class="flex gap-3">
                            <span>ğŸ’¬ <span x-text="item.comment_count"></span></span>
                            <span>â¤ï¸ <span x-text="item.like_count"></span></span>
                        </div>
                    </div>
                </div>
            </template>
            <div x-show="processedResources.length === 0" class="text-center text-gray-400 py-10 text-sm">æš‚æ— å†…å®¹</div>
        </div>
    </main>

    <footer class="text-center py-6 text-xs text-gray-400 border-t border-blue-50 mt-6">&copy; è“é²¸å°ç«™ Resource</footer>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div x-show="detailItem" x-cloak class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh] relative" @click.away="detailItem=null">
            <div class="p-5 border-b bg-white rounded-t-2xl z-10 shrink-0 flex justify-between items-start">
                <div>
                    <h2 class="text-lg font-bold text-slate-800 leading-snug" x-text="detailItem?.title"></h2>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <template x-if="detailItem?.tags">
                            <template x-for="t in detailItem.tags" :key="t.name">
                                <span class="text-[10px] px-2 py-0.5 rounded-full text-white font-bold" :class="t.type==='ç•ªç»„'?'bg-purple-400':'bg-pink-400'" x-text="t.name"></span>
                            </template>
                        </template>
                    </div>
                </div>
                <button @click="detailItem=null" class="text-gray-400 text-2xl">&times;</button>
            </div>
            
            <div class="p-5 overflow-y-auto custom-scrollbar">
                <!-- æ•´ä½“è§£é”æŒ‰é’® -->
                <div x-show="isLocked" class="mb-6 p-4 bg-blue-50 rounded-xl text-center border border-blue-100">
                    <p class="text-sm text-blue-800 mb-2 font-bold">ğŸ”’ æ­¤å¸–åŒ…å«å—é™å†…å®¹</p>
                    <button @click="unlockAll(detailItem.id)" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition">
                        æ¶ˆè€— 1 æŠŠé’¥åŒ™è§£é”å…¨éƒ¨
                    </button>
                </div>

                <div class="space-y-4 mb-8">
                    <template x-for="(block, idx) in detailItem?.content" :key="idx">
                        <div class="break-words text-sm">
                            <template x-if="block.type === 'text'"><p class="whitespace-pre-wrap text-gray-700 leading-relaxed" x-text="block.value"></p></template>
                            <template x-if="block.type === 'image'">
                                <img :src="block.isLockedMask ? 'https://via.placeholder.com/400x200?text=LOCKED' : block.value" class="rounded-lg w-full" :class="block.isLockedMask?'opacity-50 blur-sm':''">
                            </template>
                            <template x-if="block.type === 'link'">
                                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100 flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">ğŸ”—</span>
                                        <span class="font-bold text-gray-600 text-xs" x-text="block.linkType || 'å¤¸å…‹é“¾æ¥'"></span>
                                    </div>
                                    <template x-if="block.isLockedMask"><span class="text-gray-400 text-xs italic">*** å†…å®¹å·²éšè— ***</span></template>
                                    <template x-if="!block.isLockedMask">
                                        <div class="text-xs break-all font-mono select-all bg-white p-1 rounded border" x-text="block.value"></div>
                                        <a :href="block.value" target="_blank" class="text-xs text-blue-500 hover:underline text-right mt-1">è·³è½¬ &rarr;</a>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- è¯„è®ºä¸äº’åŠ¨ -->
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700 text-sm">è¯„è®ºåŒº</h3>
                        <button @click="like(detailItem.id)" class="text-pink-500 text-xs font-bold bg-pink-50 px-3 py-1 rounded-full">â¤ï¸ <span x-text="detailItem?.like_count||0"></span></button>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <input type="text" x-model="newComment" class="flex-1 border bg-gray-50 rounded-lg px-3 py-2 text-xs outline-none" placeholder="å‘è¡¨è¯„è®º...">
                        <button @click="postComment(detailItem.id)" class="bg-blue-600 text-white px-4 rounded-lg text-xs font-bold">å‘é€</button>
                    </div>
                    <div class="space-y-3">
                        <template x-for="c in comments" :key="c.id">
                            <div class="bg-gray-50 p-3 rounded-xl text-xs">
                                <div class="flex justify-between text-gray-400 mb-1"><span class="font-bold text-blue-600" x-text="c.username"></span><span x-text="new Date(c.created_at).toLocaleString()"></span></div>
                                <div class="text-gray-700" x-text="c.content"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œ (å«åŒé‡å¯†ç ) -->
    <div x-show="modalMode" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative">
            <button @click="modalMode = null" class="absolute top-4 right-4 text-gray-300 text-xl">&times;</button>
            
            <div x-show="modalMode === 'login'">
                <h2 class="text-xl font-bold text-blue-600 mb-4 text-center">ç™»å½•</h2>
                <div class="space-y-3">
                    <input type="text" x-model="form.loginId" placeholder="QQé‚®ç®± / ç”¨æˆ·å" class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none">
                    <div class="relative">
                        <input :type="showPwd?'text':'password'" x-model="form.password" placeholder="å¯†ç " class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none">
                        <button @click="showPwd=!showPwd" class="absolute right-3 top-2.5 text-xs text-gray-400" x-text="showPwd?'ğŸ™ˆ':'ğŸ‘ï¸'"></button>
                    </div>
                    <button @click="doLogin" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-sm">ç«‹å³ç™»å½•</button>
                    <div class="flex justify-between text-xs text-gray-500 px-1"><button @click="modalMode='register'">æ³¨å†Œè´¦å·</button><button @click="modalMode='reset'">æ‰¾å›å¯†ç </button></div>
                </div>
            </div>
            
            <div x-show="modalMode === 'register'">
                <h2 class="text-xl font-bold text-blue-600 mb-4 text-center">æ³¨å†Œ</h2>
                <div class="space-y-3">
                    <input type="email" x-model="form.email" placeholder="QQé‚®ç®±" class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none">
                    <div class="flex gap-2"><input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none"><button @click="sendCode('register')" :disabled="timer>0" class="w-20 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold" x-text="timer>0?timer:'å‘é€'"></button></div>
                    <input type="text" x-model="form.username" placeholder="è®¾ç½®ç”¨æˆ·å" class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none">
                    <div class="relative"><input :type="showPwd?'text':'password'" x-model="form.password" placeholder="è®¾ç½®å¯†ç " class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none"><button @click="showPwd=!showPwd" class="absolute right-2 top-2 text-xs" x-text="showPwd?'ğŸ™ˆ':'ğŸ‘ï¸'"></button></div>
                    <input :type="showPwd?'text':'password'" x-model="form.confirmPassword" placeholder="ç¡®è®¤å¯†ç " class="w-full p-2 bg-blue-50 rounded-lg text-sm outline-none">
                    <button @click="doRegister" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-sm mt-2">æ³¨å†Œå¹¶ç™»å½•</button>
                    <div class="text-center text-xs text-gray-500"><button @click="modalMode='login'">å»ç™»å½•</button></div>
                </div>
            </div>
            
            <!-- é‡ç½®ç•¥...ä¸ä¹‹å‰ç›¸åŒ -->
        </div>
    </div>

    <script>
        function app() {
            return {
                user: JSON.parse(localStorage.getItem('user') || 'null'),
                token: localStorage.getItem('token') || '',
                categories: [], resources: [], tags: [], 
                currentCat: null, currentTagType: null, currentTagId: null,
                quota: {total:0, remaining:0}, modalMode: null, showCenter: false, detailItem: null,
                form: { loginId:'', email:'', username:'', password:'', confirmPassword:'', code:'' },
                searchQ: '', newComment: '', comments: [], timer:0, sortType: 'date-desc', showPwd: false,

                get processedResources() {
                    let list = this.resources.map(r => ({...r})); // æµ…æ‹·è´
                    return list.sort((a, b) => {
                        const getDate = (item) => {
                            if (item.custom_date) {
                                const s = item.custom_date.replace(/å¹´/g, '/').replace(/æœˆ/g, '/').replace(/æ—¥/g, '');
                                const d = new Date(s); if (!isNaN(d)) return d;
                            } return new Date(item.created_at);
                        };
                        if (this.sortType === 'date-desc') return getDate(b) - getDate(a);
                        if (this.sortType === 'date-asc') return getDate(a) - getDate(b);
                        if (this.sortType === 'title-asc') return a.title.localeCompare(b.title, 'zh');
                        return 0;
                    });
                },
                get isLocked() {
                    if(!this.detailItem) return false;
                    return this.detailItem.content.some(b => b.isLockedMask);
                },

                async init() { if(this.token) this.refreshUser(); this.doSearch(); },
                
                async doSearch() {
                    let url = `/api/public/home?q=${this.searchQ}`;
                    if(this.currentTagType) url += `&tagType=${this.currentTagType}`;
                    if(this.currentTagId) url += `&tagId=${this.currentTagId}`;
                    
                    const res = await fetch(url);
                    const data = await res.json();
                    this.categories = data.categories;
                    this.resources = data.resources;
                    this.tags = data.tags || [];
                },

                filterCat(id) { this.currentCat = id; this.currentTagType=null; this.currentTagId=null; this.doSearch(); }, // è¿™é‡Œç®€å•å¤„ç†ï¼Œç‚¹åˆ†ç±»æ¸…ç©ºæ ‡ç­¾
                filterTag(type) { this.currentTagType = type; this.currentCat=null; this.currentTagId=null; this.doSearch(); },
                filterTagId(id) { this.currentTagId = id; this.doSearch(); },

                async refreshUser() { const res = await fetch('/api/user/info', { headers: {'Authorization': `Bearer ${this.token}`} }); if(res.ok) { const data = await res.json(); this.user = data.user; this.quota = data.quota; localStorage.setItem('user', JSON.stringify(data.user)); } else this.logout(); },
                showUserCenter() { location.href = '/user'; },
                openModal(mode) { this.modalMode = mode; this.form = {loginId:'', email:'', username:'', password:'', confirmPassword:'', code:''}; this.showPwd=false; },
                getCatName(id) { const c = this.categories.find(cat => cat.id == id); return c ? c.name : 'æœªåˆ†ç±»'; },

                // è®¤è¯
                async sendCode(type) { if(!this.form.email) return alert('é‚®ç®±å¿…å¡«'); const res = await fetch('/api/auth/send-code', {method:'POST', body:JSON.stringify({email:this.form.email, type})}); if(res.ok){ alert('å‘é€æˆåŠŸ'); this.timer=60; setInterval(()=>this.timer>0&&this.timer--,1000); } else alert((await res.json()).error); },
                async doRegister() {
                    if(this.form.password !== this.form.confirmPassword) return alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´');
                    const res = await fetch('/api/auth/register', {method:'POST', body:JSON.stringify(this.form)});
                    const data = await res.json(); if(res.ok) this.loginSuccess(data); else alert(data.error);
                },
                async doLogin() { const res = await fetch('/api/auth/login', {method:'POST', body:JSON.stringify({...this.form, isAdmin:false})}); const data = await res.json(); if(res.ok) this.loginSuccess(data); else alert(data.error); },
                loginSuccess(data) { this.user=data.user; this.token=data.token; localStorage.setItem('user', JSON.stringify(data.user)); localStorage.setItem('token', data.token); this.modalMode=null; this.refreshUser(); },
                logout() { localStorage.clear(); location.reload(); },

                // è§£é” (ä¸€æ¬¡è§£é”å…¨éƒ¨)
                async unlockAll(resourceId) {
                    if(!this.user) return this.modalMode = 'login';
                    if(!confirm('æ¶ˆè€— 1 æŠŠé’¥åŒ™è§£é”æ­¤å¸–å…¨éƒ¨å†…å®¹? (ä»Šæ—¥é‡å¤çœ‹å…è´¹)')) return;
                    
                    const res = await fetch('/api/resource/unlock', {
                        method:'POST', headers:{'Authorization':`Bearer ${this.token}`},
                        body:JSON.stringify({resourceId})
                    });
                    const data = await res.json();
                    if(res.ok) {
                        // æ›¿æ¢æ‰€æœ‰å—é™å†…å®¹
                        const fullContent = data.fullContent;
                        this.detailItem.content = this.detailItem.content.map((b, idx) => {
                            if(b.isLockedMask) return { ...b, value: fullContent[idx].value, isLockedMask: false };
                            return b;
                        });
                        this.refreshUser();
                    } else alert(data.error);
                },

                async openDetail(item) { this.detailItem = JSON.parse(JSON.stringify(item)); const res = await fetch(`/api/resource/comments/${item.id}`); this.comments = await res.json(); },
                async postComment(rid) { if(!this.user) return this.modalMode = 'login'; if(!this.newComment) return; await fetch('/api/resource/comment', {method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:JSON.stringify({resourceId:rid, content:this.newComment})}); this.newComment = ''; this.openDetail(this.detailItem); },
                async like(rid) { if(!this.user) return this.modalMode = 'login'; await fetch('/api/resource/like', {method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:JSON.stringify({resourceId:rid})}); this.detailItem.like_count++; },
            }
        }
    </script>
</body>
</html>
