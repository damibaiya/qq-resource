<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸ä¸­æ§å° Ultimate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script>
        const SUPABASE_URL = 'https://toiggxduohuapmfnszcu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaWdneGR1b2h1YXBtZm5zemN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NzU5MDksImV4cCI6MjA4MTI1MTkwOX0.tSTWbyOcoKD9bx8-NjwG_KCktMcGlQZbbrGAP_0hXng';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = client;
    </script>
    <style>
        [x-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .modal-body { max-height: 85vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans" x-data="admin()">

    <!-- ç™»å½•é¡µ -->
    <div x-show="!isAdmin" class="min-h-screen flex items-center justify-center bg-slate-900">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center">
            <h1 class="font-bold mb-6 text-2xl text-slate-800">ç®¡ç†å‘˜ç™»å½•</h1>
            <input type="text" x-model="loginInput" placeholder="è´¦å·" class="w-full border p-3 mb-3 rounded-lg outline-none focus:border-blue-500">
            <input type="password" x-model="password" placeholder="å¯†ç " class="w-full border p-3 mb-6 rounded-lg outline-none focus:border-blue-500">
            <button @click="login" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">ç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div x-show="isAdmin" class="min-h-screen flex" x-cloak>
        <nav class="w-56 bg-slate-900 text-white flex flex-col fixed h-full z-20 shadow-xl">
            <div class="p-6 font-bold text-xl border-b border-slate-800 flex items-center gap-2"><span>ğŸ³</span> ä¸­æ§å°</div>
            <div class="flex-1 py-4 space-y-1 overflow-y-auto">
                <template x-for="item in menu" :key="item.id">
                    <button @click="switchTab(item.id)" 
                        :class="tab===item.id ? 'bg-blue-600 text-white border-r-4 border-blue-400' : 'text-slate-400 hover:bg-slate-800 hover:text-white'" 
                        class="w-full text-left px-6 py-3.5 text-sm font-medium transition flex justify-between items-center group">
                        <span x-text="item.label"></span>
                        <span x-show="item.id==='msg' && unreadCount > 0" class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" x-text="unreadCount"></span>
                    </button>
                </template>
            </div>
            <div class="p-4 border-t border-slate-800">
                <button @click="logout" class="w-full py-2 text-center text-red-400 hover:bg-slate-800 rounded transition text-sm font-bold">é€€å‡º</button>
            </div>
        </nav>

        <main class="flex-1 ml-56 p-8 bg-gray-100 min-h-screen">
            <!-- 1. æ¦‚è§ˆ -->
            <div x-show="tab==='dash'" class="space-y-6">
                <h2 class="text-2xl font-bold mb-6">æ¦‚è§ˆ</h2>
                <div class="grid grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><div class="text-slate-400 text-xs font-bold uppercase">æ€»ç”¨æˆ·</div><div class="text-3xl font-black text-slate-800 mt-2" x-text="stats.users">0</div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><div class="text-slate-400 text-xs font-bold uppercase">æ€»å¸–å­</div><div class="text-3xl font-black text-blue-600 mt-2" x-text="stats.posts">0</div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 col-span-2"><div class="text-slate-400 text-xs font-bold uppercase">å®‰å…¨å®¡è®¡</div><div class="mt-2 text-sm text-slate-600 font-mono"><p>IP: <span x-text="stats.ip"></span></p><p class="truncate text-xs" x-text="navigator.userAgent"></p></div></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><h3 class="font-bold mb-4 text-lg">ç™»å½•å†å²</h3><div class="overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 font-bold"><tr><th class="p-3">æ—¶é—´</th><th class="p-3">IPåœ°å€</th><th class="p-3">è®¾å¤‡</th><th class="p-3">æ“ä½œ</th></tr></thead><tbody class="divide-y divide-slate-50"><template x-for="log in stats.logs"><tr class="hover:bg-slate-50"><td class="p-3 text-slate-600" x-text="new Date(log.created_at).toLocaleString()"></td><td class="p-3 font-mono text-xs text-blue-500" x-text="log.ip_address"></td><td class="p-3 text-xs text-slate-400 truncate max-w-[200px]" x-text="log.user_agent||'Unknown'"></td><td class="p-3 text-xs font-bold badge" x-text="log.action"></td></tr></template></tbody></table></div></div>
            </div>

            <!-- 2. å‘å¸ƒ -->
            <div x-show="tab==='post'" class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-slate-100">
                <h2 class="text-2xl font-bold mb-6 text-blue-600">ğŸ“ å‘å¸ƒèµ„æº</h2>
                <div class="grid gap-5">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">æ ‡é¢˜ (è‡ªåŠ¨è¯†åˆ«æ—¥æœŸ)</label><input type="text" x-model="post.title" @blur="autoParseDate('post')" class="w-full border p-3 rounded-lg bg-slate-50 outline-none focus:bg-white transition" placeholder="ä¾‹å¦‚: [ç»¼è‰º]2018.01.05æœŸ"></div>
                    <div class="grid grid-cols-2 gap-5"><div><label class="block text-xs font-bold text-slate-500 mb-1">åˆ†ç±»</label><select x-model="post.category_id" class="w-full border p-3 rounded-lg bg-slate-50"><template x-for="c in categories" :key="c.id"><option :value="c.id" x-text="c.name"></option></template></select></div><div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="text" x-model="post.custom_date" class="w-full border p-3 rounded-lg bg-slate-50"></div></div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100"><label class="block text-xs font-bold text-slate-500 mb-2">å†…å®¹ <span class="text-red-500">*å¿…é¡»å«é“¾æ¥</span></label><template x-for="(b,i) in post.blocks" :key="i"><div class="flex gap-2 mb-2 items-center bg-white p-2 rounded border border-slate-200"><select x-model="b.type" class="border p-1.5 rounded text-xs bg-slate-50 font-bold"><option value="text">æ–‡</option><option value="link">é“¾</option><option value="image">å›¾</option></select><input x-show="b.type!=='image'" type="text" x-model="b.value" class="flex-1 border p-1.5 rounded text-sm outline-none"><div x-show="b.type==='image'" class="flex-1 flex gap-2 items-center"><input type="file" @change="uploadImg($event,i,'post')" class="text-xs text-slate-500"><span x-show="b.value" class="text-green-500 text-xs font-bold">âœ…</span></div><div x-show="b.type==='link'" class="flex items-center gap-1 px-2 border-l"><input type="checkbox" x-model="b.locked"><span class="text-xs font-bold text-slate-500">é”</span></div><button @click="post.blocks.splice(i,1)" class="text-red-400 hover:text-red-600 p-1">âœ•</button></div></template><button @click="addBlock" class="mt-2 text-xs font-bold text-blue-600 border border-blue-200 bg-white px-3 py-1.5 rounded-lg hover:bg-blue-50">+ æ·»åŠ ä¸€è¡Œ</button></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-2">æ ‡ç­¾</label><div class="flex gap-2 mb-3"><input type="text" x-model="newTag" placeholder="æ ‡ç­¾å" class="border p-2 rounded-lg w-40 text-sm outline-none"><select x-model="newTagType" class="border p-2 rounded-lg text-sm bg-white"><option value="ç•ªç»„">ç•ªç»„</option><option value="è‰ºäºº">è‰ºäºº</option></select><button @click="addPostTag('post')" class="bg-slate-800 text-white px-4 rounded-lg text-sm font-bold">æ·»åŠ </button></div><div class="flex gap-2 flex-wrap"><template x-for="(t,i) in post.tags"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1"><span x-text="t.name"></span><button @click="post.tags.splice(i,1)" class="text-blue-400 hover:text-blue-600 font-black">âœ•</button></span></template></div></div>
                    <button @click="publish" class="bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 shadow-lg mt-2">ğŸš€ ç«‹å³å‘å¸ƒ</button>
                </div>
            </div>

            <!-- 3. æ–‡ç« åˆ—è¡¨ -->
            <div x-show="tab==='list'">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">æ–‡ç« åˆ—è¡¨</h2><div class="flex gap-3"><input type="text" x-model="resSearchQ" @keyup.enter="loadResources(0)" placeholder="æœæ ‡é¢˜..." class="border p-2 rounded text-sm w-64"><button @click="loadResources(0)" class="bg-blue-600 text-white px-4 rounded text-sm font-bold">æœç´¢</button><button @click="batchDelete" class="bg-red-100 text-red-600 px-4 rounded text-sm font-bold">æ‰¹é‡åˆ é™¤</button></div></div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 font-bold"><tr><th class="p-4 w-10"><input type="checkbox" @click="toggleAllRes"></th><th class="p-4 w-16">ID</th><th class="p-4">æ ‡é¢˜</th><th class="p-4 w-24">æ—¥æœŸ</th><th class="p-4 w-20">åˆ†ç±»</th><th class="p-4 w-32">æ“ä½œ</th></tr></thead><tbody class="divide-y divide-slate-50"><template x-for="r in resources" :key="r.id"><tr class="hover:bg-slate-50"><td class="p-4"><input type="checkbox" x-model="r.selected"></td><td class="p-4 text-slate-400" x-text="r.id"></td><td class="p-4 font-bold text-slate-700" x-text="r.title"></td><td class="p-4 text-slate-500 text-xs" x-text="r.custom_date"></td><td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600" x-text="getCatName(r.category_id)"></span></td><td class="p-4 flex gap-2"><button @click="openEditModal(r)" class="text-blue-500 font-bold text-xs hover:underline">ç¼–è¾‘</button><button @click="delRes(r.id)" class="text-red-500 font-bold text-xs hover:underline">åˆ é™¤</button></td></tr></template></tbody></table><div class="p-4 border-t flex justify-between items-center bg-slate-50"><div class="text-xs text-slate-500">å…± <span x-text="resTotal"></span> æ¡ï¼Œ<span x-text="resTotalPages"></span> é¡µ</div><div class="flex items-center gap-2"><button @click="loadResources(resPage-1)" :disabled="resPage<=0" class="px-3 py-1 bg-white border rounded text-xs disabled:opacity-50">ä¸Šä¸€é¡µ</button><input type="number" x-model="jumpPage" class="w-12 text-center border rounded text-xs p-1" @keyup.enter="goToResPage"><button @click="goToResPage" class="px-2 py-1 bg-blue-600 text-white rounded text-xs">è·³è½¬</button><button @click="loadResources(resPage+1)" :disabled="resPage>=resTotalPages-1" class="px-3 py-1 bg-white border rounded text-xs disabled:opacity-50">ä¸‹ä¸€é¡µ</button></div></div></div>
            </div>

            <!-- 4. ç”¨æˆ·ç®¡ç† -->
            <div x-show="tab==='users'">
                <h2 class="text-2xl font-bold mb-6">ç”¨æˆ·ç®¡ç†</h2>
                <div class="flex gap-2 mb-4"><input x-model="userSearchQ" placeholder="æœé‚®ç®±/æ˜µç§°..." class="border p-2 rounded flex-1"><button @click="loadUsers(0)" class="bg-blue-600 text-white px-4 rounded font-bold">æœç´¢</button></div>
                <div class="space-y-4"><template x-for="u in users"><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition"><div class="flex justify-between items-start mb-4"><div><div class="flex items-center gap-2"><div class="font-bold text-lg text-slate-800" x-text="u.username||u.email.split('@')[0]"></div></div><div class="text-xs text-slate-400 mt-1" x-text="u.email"></div><div class="text-xs text-slate-400 mt-1">æ³¨å†Œ: <span x-text="new Date(u.created_at).toLocaleDateString()"></span> | è¿ç­¾: <span class="text-orange-600 font-bold" x-text="u.consecutive_days||0"></span> å¤© | é’¥åŒ™: <span class="text-blue-600 font-bold" x-text="u.keys_count"></span></div></div><div class="text-right flex flex-col items-end"><div class="text-xs text-purple-600 font-bold bg-purple-50 px-2 py-1 rounded mb-2" x-show="u.override_key_count">ğŸ”’ ç‰¹æƒç”Ÿæ•ˆä¸­</div></div></div><div class="bg-slate-50 p-4 rounded-lg text-sm grid gap-4 border border-slate-100"><div class="flex justify-between items-center"><label class="font-bold text-slate-500 text-xs">æ™®é€šä¿®æ”¹</label><div class="flex gap-2"><input type="number" x-model="u.edit_keys" class="border p-1.5 rounded w-20 text-center bg-white"><button @click="saveUser(u)" class="bg-green-500 text-white px-3 rounded text-xs font-bold">ä¿å­˜</button></div></div><div class="border-t border-slate-200 pt-3 flex justify-between items-center"><label class="font-bold text-purple-600 text-xs">ç‰¹æƒè®¾å®š</label><button @click="openPrivilegeModal(u)" class="bg-purple-100 text-purple-600 px-3 py-1.5 rounded text-xs font-bold">è®¾ç½®ç‰¹æƒ</button></div><div class="border-t border-slate-200 pt-3 text-right"><button @click="openDM(u)" class="text-blue-500 font-bold text-xs border border-blue-200 px-4 py-1.5 rounded hover:bg-blue-50">å‘ç§ä¿¡</button></div></div></div></template></div><div class="p-4 text-center"><button @click="loadUsers(userPage+1)" class="text-slate-400 text-xs hover:text-blue-500 font-bold">åŠ è½½æ›´å¤š...</button></div>
            </div>

            <!-- 5. å…³é”®è¯ç®¡ç† -->
            <div x-show="tab==='keywords'">
                <h2 class="text-2xl font-bold mb-6">å…³é”®è¯ç®¡ç†</h2>
                <div class="flex gap-3 mb-6"><input x-model="kwSearchQ" @keyup.enter="loadKeywords(0)" placeholder="æœå…³é”®è¯..." class="border p-2 rounded flex-1 shadow-sm"><button @click="loadKeywords(0)" class="bg-blue-600 text-white px-4 rounded font-bold">æœç´¢</button><button @click="openAddKeyword" class="bg-green-600 text-white px-4 rounded font-bold">+ æ·»åŠ å…³é”®è¯</button><button @click="batchDelKw" class="bg-red-100 text-red-600 px-4 rounded font-bold">åˆ é™¤é€‰ä¸­</button></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 font-bold text-slate-500"><tr><th class="p-4 w-10"><input type="checkbox" @click="toggleAllKw"></th><th class="p-4">å…³é”®è¯</th><th class="p-4">å…³è”è§„åˆ™</th><th class="p-4 w-24">æ“ä½œ</th></tr></thead><tbody class="divide-y divide-slate-50"><template x-for="k in keywords"><tr class="hover:bg-slate-50"><td class="p-4"><input type="checkbox" x-model="k.selected"></td><td class="p-4 font-bold text-slate-700" x-text="k.keyword"></td><td class="p-4"><div class="flex flex-wrap gap-1"><template x-for="def in k.definitions"><span class="bg-purple-50 text-purple-600 px-2 py-0.5 rounded text-xs border border-purple-100" x-text="def.tag_name+' ('+def.tag_type+')'"></span></template></div></td><td class="p-4"><button @click="editKeyword(k)" class="text-blue-500 font-bold text-xs hover:underline mr-2">ç¼–è¾‘</button></td></tr></template></tbody></table><div class="p-3 border-t flex justify-between items-center bg-slate-50"><span class="text-xs text-slate-500 font-bold" x-text="`å…± ${kwTotal} æ¡ï¼Œ${kwPage+1} / ${kwTotalPages} é¡µ`"></span><div class="flex gap-1"><button @click="loadKeywords(kwPage-1)" :disabled="kwPage<=0" class="px-2 bg-white border rounded disabled:opacity-50">â€¹</button><input type="number" x-model="jumpKwPage" class="w-10 text-center border rounded text-xs p-1" @keyup.enter="goToKwPage"><button @click="goToKwPage" class="px-2 bg-blue-100 text-blue-600 rounded text-xs">Go</button><button @click="loadKeywords(kwPage+1)" :disabled="kwPage>=kwTotalPages-1" class="px-2 bg-white border rounded disabled:opacity-50">â€º</button></div></div></div>
            </div>

            <!-- 6. æ ‡ç­¾/åˆ†ç±»/å¤‡ä»½ -->
            <div x-show="tab==='tags'"><h2 class="text-2xl font-bold mb-6">æ ‡ç­¾ç®¡ç†</h2><div class="flex gap-4 mb-4"><button @click="tagType='ç•ªç»„';loadAllTags()" :class="tagType==='ç•ªç»„'?'bg-blue-600 text-white':'bg-white'" class="px-4 py-2 rounded shadow">ç•ªç»„</button><button @click="tagType='è‰ºäºº';loadAllTags()" :class="tagType==='è‰ºäºº'?'bg-pink-600 text-white':'bg-white'" class="px-4 py-2 rounded shadow">è‰ºäºº</button></div><div class="grid grid-cols-8 gap-3"><template x-for="t in allTags"><div class="bg-white p-2 rounded shadow text-center group relative cursor-pointer hover:shadow-md transition" @click="openEditTag(t)"><img :src="t.image_url||'https://ui-avatars.com/api/?name='+t.name" class="w-full aspect-square object-cover rounded mb-2"><div class="text-[10px] font-bold truncate" x-text="t.name"></div><button @click.stop="delTag(t.id)" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] hidden group-hover:block">Ã—</button></div></template></div></div>
            <div x-show="tab==='cats'"><h2 class="text-2xl font-bold mb-6">åˆ†ç±»ç®¡ç†</h2><div class="flex gap-2 mb-4"><input x-model="newCatName" placeholder="æ–°åˆ†ç±»åç§°" class="border p-2 rounded shadow-sm"><button @click="addCat" class="bg-green-600 text-white px-4 rounded font-bold">æ·»åŠ </button></div><div class="space-y-2 max-w-md"><template x-for="c in categories"><div class="bg-white p-3 rounded flex justify-between border hover:bg-slate-50"><span x-text="c.name" class="font-bold"></span><button @click="delCat(c.id)" class="text-red-500 text-xs font-bold hover:underline">åˆ é™¤</button></div></template></div></div>
            <div x-show="tab==='backup'"><h2 class="text-2xl font-bold mb-6">å¤‡ä»½ä¸æ¢å¤</h2><div class="grid grid-cols-2 gap-8"><div class="bg-white p-8 rounded-xl shadow-sm border text-center hover:shadow-md transition"><div class="text-4xl mb-4">ğŸ“¤</div><h3 class="font-bold text-lg mb-2">å¯¼å‡ºæ•°æ®</h3><button @click="backupData" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold w-full hover:bg-green-700">ä¸‹è½½ JSON å¤‡ä»½</button></div><div class="bg-white p-8 rounded-xl shadow-sm border text-center hover:shadow-md transition"><div class="text-4xl mb-4">ğŸ“¥</div><h3 class="font-bold text-lg mb-2">æ¢å¤æ•°æ®</h3><input type="file" id="restoreFile" class="mb-4 block w-full text-xs text-slate-500"><button @click="restoreData" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold w-full hover:bg-blue-700">å¼€å§‹æ¢å¤</button></div></div></div>

            <!-- 7. ç§ä¿¡ä¸­å¿ƒ -->
            <div x-show="tab==='msg'"><h2 class="text-2xl font-bold mb-6">ç§ä¿¡ä¸­å¿ƒ</h2><div class="grid grid-cols-3 gap-4 h-[600px]"><div class="bg-white rounded-xl border overflow-y-auto"><template x-for="c in conversations"><div @click="activeChat=c;loadChatMsgs()" class="p-4 border-b hover:bg-slate-50 cursor-pointer transition" :class="activeChat?.user_id===c.user_id?'bg-blue-50 border-l-4 border-blue-500':''"><div class="flex justify-between"><div class="font-bold text-sm text-slate-800" x-text="c.username || 'æœªçŸ¥'"></div><div x-show="!c.read" class="w-2 h-2 bg-red-500 rounded-full"></div></div><div class="text-xs text-slate-400 truncate mt-1" x-text="c.last_msg"></div></div></template></div><template x-if="activeChat"><div class="col-span-2 bg-white rounded-xl border flex flex-col"><div class="p-4 border-b font-bold bg-slate-50 text-slate-700" x-text="'ä¸ '+(activeChat.username||'ç”¨æˆ·')+' å¯¹è¯'"></div><div class="flex-1 overflow-y-auto p-4 space-y-4" id="admChatBox"><template x-for="m in chatMsgs"><div class="flex flex-col" :class="m.sender==='admin'?'items-end':'items-start'"><div class="max-w-[80%] p-3 rounded-2xl text-sm shadow-sm" :class="m.sender==='admin'?'bg-blue-600 text-white rounded-br-none':'bg-slate-100 text-slate-800 rounded-bl-none'"><span x-text="m.content"></span></div><span class="text-[10px] text-slate-300 mt-1" x-text="new Date(m.created_at).toLocaleString()"></span></div></template></div><div class="p-4 border-t flex gap-3"><input type="text" x-model="chatInput" class="flex-1 border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-200" @keyup.enter="sendAdmMsg" placeholder="è¾“å…¥å›å¤..."><button @click="sendAdmMsg" class="bg-blue-600 text-white px-6 rounded-lg font-bold hover:bg-blue-700 transition">å‘é€</button></div></div></template><template x-if="!activeChat"><div class="col-span-2 flex items-center justify-center text-gray-400 font-bold">è¯·é€‰æ‹©ä¸€ä¸ªå¯¹è¯</div></template></div></div>
            
            <!-- 8. å…³è”ç®¡ç† -->
            <div x-show="tab==='assoc'"><h2 class="text-2xl font-bold mb-6">å…³è”ç®¡ç†</h2><div class="flex gap-3 mb-6"><input x-model="assocSearch" @keyup.enter="loadAssoc(0)" placeholder="æœå¸–å­æˆ–æ ‡ç­¾..." class="border p-2 rounded flex-1"><button @click="loadAssoc(0)" class="bg-blue-600 text-white px-4 rounded font-bold">æœç´¢</button><button @click="openAddAssoc" class="bg-green-600 text-white px-4 rounded font-bold">+ æ·»åŠ å…³è”</button><button @click="batchDelAssoc" class="bg-red-100 text-red-600 px-4 rounded font-bold">æ‰¹é‡è§£é™¤</button></div><div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 font-bold text-slate-500"><tr><th class="p-3 w-10"><input type="checkbox" @click="toggleAllAssoc"></th><th class="p-3">å¸–å­</th><th class="p-3">æ ‡ç­¾</th><th class="p-3">ç±»å‹</th><th class="p-3">æ“ä½œ</th></tr></thead><tbody class="divide-y divide-slate-50"><template x-for="a in assocs"><tr class="hover:bg-slate-50"><td class="p-3"><input type="checkbox" x-model="a.selected"></td><td class="p-3 font-bold text-slate-700" x-text="a.resource_title"></td><td class="p-3"><span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs" x-text="a.tag_name"></span></td><td class="p-3 text-xs text-slate-400" x-text="a.tag_type"></td><td class="p-3"><button @click="delAssoc(a)" class="text-red-500 text-xs font-bold">è§£é™¤</button></td></tr></template></tbody></table><div class="p-3 border-t flex justify-between items-center bg-slate-50"><span class="text-xs text-slate-500" x-text="`ç¬¬ ${assocPage+1} é¡µ`"></span><div class="flex gap-1"><button @click="loadAssoc(assocPage-1)" :disabled="assocPage<=0" class="px-2 bg-white border rounded">â€¹</button><input type="number" x-model="jumpAssocPage" class="w-10 text-center border rounded text-xs p-1" @keyup.enter="goToAssocPage"><button @click="goToAssocPage" class="px-2 bg-blue-100 text-blue-600 rounded text-xs">Go</button><button @click="loadAssoc(assocPage+1)" :disabled="assocs.length<50" class="px-2 bg-white border rounded">â€º</button></div></div></div></div>
        </main>
    </div>

    <!-- å¼¹çª—ï¼šç¼–è¾‘æ–‡ç«  -->
    <div x-show="editModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-[800px] modal-body shadow-2xl"><h3 class="font-bold mb-4 text-lg">ç¼–è¾‘æ–‡ç« </h3><div class="grid gap-4"><div><label class="text-xs font-bold text-gray-500">æ ‡é¢˜</label><input x-model="editPostData.title" @blur="autoParseDate('edit')" class="w-full border p-2 rounded"></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500">åˆ†ç±»</label><select x-model="editPostData.category_id" class="w-full border p-2 rounded"><template x-for="c in categories"><option :value="c.id" x-text="c.name"></option></template></select></div><div><label class="text-xs font-bold text-gray-500">æ—¥æœŸ</label><input x-model="editPostData.custom_date" class="w-full border p-2 rounded"></div></div><div><label class="text-xs font-bold text-gray-500">æ ‡ç­¾ç®¡ç†</label><div class="flex gap-2 mb-2"><input x-model="newTag" placeholder="æ–°æ ‡ç­¾å" class="border p-1 rounded text-sm w-32"><select x-model="newTagType" class="border text-sm p-1"><option value="ç•ªç»„">ç•ªç»„</option><option value="è‰ºäºº">è‰ºäºº</option></select><button @click="addPostTag('edit')" class="bg-blue-600 text-white px-3 rounded text-xs font-bold">æ·»åŠ </button></div><div class="flex gap-2 flex-wrap bg-gray-50 p-2 rounded"><template x-for="(t,i) in editPostData.tags"><span class="bg-white border border-blue-200 text-blue-800 px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm"><span x-text="t.name"></span><button @click="editPostData.tags.splice(i,1)" class="text-red-400 hover:text-red-600 font-bold ml-1">Ã—</button></span></template></div></div><div class="bg-gray-50 p-3 rounded"><label class="text-xs font-bold text-gray-500 mb-2">å†…å®¹</label><template x-for="(b,i) in editPostData.blocks" :key="i"><div class="flex gap-2 mb-2"><select x-model="b.type" class="border text-xs"><option value="text">æ–‡</option><option value="link">é“¾</option><option value="image">å›¾</option></select><input x-show="b.type!=='image'" type="text" x-model="b.value" class="flex-1 border p-1 text-sm"><div x-show="b.type==='image'" class="flex-1 flex gap-2"><input type="file" @change="uploadImg($event,i,'edit')" class="text-xs"><span x-show="b.value" class="text-green-500 text-xs">OK</span></div><div x-show="b.type==='link'" class="flex items-center gap-1"><input type="checkbox" x-model="b.locked"><span class="text-xs">é”</span></div><button @click="editPostData.blocks.splice(i,1)" class="text-red-500">Ã—</button></div></template><button @click="editPostData.blocks.push({type:'text',value:'',locked:true})" class="text-xs bg-white border px-2 py-1 rounded">+ æ·»åŠ </button></div><div class="flex justify-end gap-2 mt-4"><button @click="editModal=false" class="px-4 py-2 bg-gray-100 rounded">å–æ¶ˆ</button><button @click="saveEditPost" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">ä¿å­˜ä¿®æ”¹</button></div></div></div></div>
    <!-- å¼¹çª—ï¼šç¼–è¾‘æ ‡ç­¾ -->
    <div x-show="tagModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-[600px] modal-body shadow-2xl"><h3 class="font-bold mb-4 text-lg border-b pb-2">ç¼–è¾‘æ ‡ç­¾ä¸å¸–å­</h3><div class="flex gap-2 mb-4"><input x-model="editTagData.name" class="w-1/3 border p-2 rounded text-sm" placeholder="æ ‡ç­¾å"><select x-model="editTagData.type" class="w-1/4 border p-2 rounded text-sm"><option value="ç•ªç»„">ç•ªç»„</option><option value="è‰ºäºº">è‰ºäºº</option></select><input x-model="editTagData.image_url" class="flex-1 border p-2 rounded text-sm" placeholder="å›¾ç‰‡URL"><button @click="saveEditTag" class="px-3 bg-blue-600 text-white rounded text-sm">ä¿å­˜</button></div><h4 class="font-bold text-xs text-gray-500 mb-2">è¯¥æ ‡ç­¾ä¸‹çš„å¸–å­</h4><div class="bg-gray-50 rounded border h-64 overflow-y-auto p-2"><template x-for="p in tagPosts"><div class="flex justify-between items-center border-b p-2 hover:bg-white text-sm"><span class="truncate w-3/4 font-bold" x-text="p.title"></span><span class="text-xs text-gray-400" x-text="p.custom_date"></span></div></template><div x-show="tagPosts.length===0" class="text-center text-xs text-gray-400 mt-10">æš‚æ— å¸–å­</div></div><div class="flex justify-end mt-4"><button @click="tagModal=false" class="px-4 py-2 bg-gray-100 rounded text-sm font-bold">å…³é—­</button></div></div></div>
    <!-- ç‰¹æƒå¼¹çª— -->
    <div x-show="privModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-96 shadow-2xl"><h3 class="font-bold mb-4">è®¾ç½®ç‰¹æƒ</h3><div class="mb-3"><label class="block text-xs font-bold text-gray-500">é”å®šé’¥åŒ™æ•°é‡</label><input type="number" x-model="privData.count" class="w-full border p-2 rounded bg-gray-50 font-bold text-center"></div><div class="mb-4"><label class="block text-xs font-bold text-gray-500">æ—¥æœŸèŒƒå›´</label><div class="flex gap-2"><input type="date" x-model="privData.start" class="border p-2 rounded w-full text-xs"><input type="date" x-model="privData.end" class="border p-2 rounded w-full text-xs"></div></div><div class="flex justify-end gap-2"><button @click="privModal=false" class="px-4 py-2 bg-gray-100 rounded">å–æ¶ˆ</button><button @click="savePrivilege" class="px-4 py-2 bg-purple-600 text-white rounded font-bold">ä¿å­˜</button></div></div></div>
    <!-- å…³é”®è¯å¼¹çª— -->
    <div x-show="kwModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-[500px] modal-body shadow-2xl"><h3 class="font-bold mb-4 text-lg">ç¼–è¾‘/æ·»åŠ å…³é”®è¯</h3><div class="mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">å…³é”®è¯</label><input x-model="editKwData.keyword" class="w-full border p-2 rounded bg-blue-50 font-bold" placeholder="ä¾‹å¦‚: VSå²š"></div><div class="mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">å…³è”çš„æ ‡ç­¾è§„åˆ™</label><div class="flex flex-wrap gap-2 min-h-[40px] bg-gray-50 p-2 rounded border"><template x-for="(t, i) in editKwData.tags"><span class="bg-white border px-2 py-1 rounded text-xs flex items-center gap-1 shadow-sm"><span x-text="t.name+' ('+t.type+')'"></span><button @click="editKwData.tags.splice(i,1)" class="text-red-500 font-bold">Ã—</button></span></template><span x-show="editKwData.tags.length===0" class="text-xs text-gray-400">æš‚æ— è§„åˆ™</span></div></div><div class="mb-4 bg-slate-50 p-3 rounded border"><label class="block text-xs font-bold text-gray-500 mb-2">æ·»åŠ è§„åˆ™ (ç›´æ¥è¾“å…¥)</label><div class="flex gap-2"><input x-model="kwNewTagName" placeholder="æ ‡ç­¾å" class="flex-1 border p-1 rounded text-sm"><select x-model="kwNewTagType" class="border p-1 rounded text-sm"><option value="ç•ªç»„">ç•ªç»„</option><option value="è‰ºäºº">è‰ºäºº</option></select><button @click="addRuleToKw" class="bg-blue-600 text-white px-3 rounded text-xs">æ·»åŠ </button></div></div><div class="flex justify-end gap-2"><button @click="kwModal=false" class="px-4 py-2 bg-gray-100 rounded">å–æ¶ˆ</button><button @click="saveKeyword" class="px-4 py-2 bg-green-600 text-white rounded font-bold">ä¿å­˜</button></div></div></div>
    <!-- å…³è”å¼¹çª— -->
    <div x-show="assocModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-96 shadow-2xl"><h3 class="font-bold mb-4">æ‰‹åŠ¨å…³è”å¸–å­ä¸æ ‡ç­¾</h3><div class="mb-3"><label class="block text-xs font-bold text-gray-500 mb-1">å¸–å­ID</label><input type="number" x-model="newAssocData.resource_id" placeholder="ID" class="w-full border p-2 rounded"></div><div class="mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">æ ‡ç­¾</label><div class="flex gap-2"><input x-model="newAssocData.tag_name" placeholder="åç§°" class="flex-1 border p-2 rounded"><select x-model="newAssocData.tag_type" class="border p-2 rounded text-sm"><option value="ç•ªç»„">ç•ªç»„</option><option value="è‰ºäºº">è‰ºäºº</option></select></div></div><div class="flex justify-end gap-2"><button @click="assocModal=false" class="px-4 py-2 bg-gray-100 rounded">å–æ¶ˆ</button><button @click="saveAssoc" class="px-4 py-2 bg-green-600 text-white rounded font-bold">å…³è”</button></div></div></div>

    <script>
        function admin(){return{
            isAdmin:false,user:null,tab:'dash',loginInput:'',password:'',
            menu:[{id:'dash',label:'æ¦‚è§ˆ'},{id:'post',label:'å‘å¸ƒ'},{id:'list',label:'æ–‡ç« '},{id:'users',label:'ç”¨æˆ·'},{id:'keywords',label:'å…³é”®è¯'},{id:'assoc',label:'å…³è”'},{id:'msg',label:'ç§ä¿¡'},{id:'tags',label:'æ ‡ç­¾'},{id:'cats',label:'åˆ†ç±»'},{id:'backup',label:'å¤‡ä»½'}],
            stats:{users:0,posts:0,ip:'...',logs:[]},unreadCount:0,
            post:{title:'',category_id:null,custom_date:'',blocks:[{type:'link',value:'',locked:true}],tags:[]},newTag:'',newTagType:'ç•ªç»„',categories:[],
            resources:[],resPage:0,resTotal:0,resTotalPages:0,jumpPage:1,resSearchQ:'',
            users:[],userPage:0,userSearchQ:'',
            conversations:[],activeChat:null,chatMsgs:[],chatInput:'',
            allTags:[],tagType:'ç•ªç»„',newCatName:'',
            keywords:[], kwPage:0, kwTotal:0, kwTotalPages:0, jumpKwPage:1, kwSearchQ:'', kwModal:false, editKwData:{tags:[]}, kwNewTagName:'', kwNewTagType:'ç•ªç»„',
            tagModal:false, editTagData:{}, tagPosts:[],
            assocModal:false, newAssocData:{resource_id:'',tag_name:'',tag_type:'ç•ªç»„'}, assocs:[], assocSearch:'', assocPage:0, assocTotal:0, assocTotalPages:0, jumpAssocPage:1,
            editModal:false,editPostData:{blocks:[],tags:[]},privModal:false,privData:{},

            async init(){const{data}=await window.supabase.auth.getSession();if(data.session)await this.check(data.session.user.id);this.getIP()},
            async getIP(){try{const r=await fetch('https://api.ipify.org?format=json');const j=await r.json();this.stats.ip=j.ip;if(this.isAdmin)this.logLogin()}catch(e){this.stats.ip='Unknown';if(this.isAdmin)this.logLogin()}},
            async login(){if(!this.loginInput||!this.password)return alert('è¯·å¡«å†™');let e=this.loginInput;if(!e.includes('@')){const{data}=await window.supabase.from('profiles').select('email').eq('username',e).single();if(data)e=data.email;else return alert('æ— æ­¤äºº')}const{data,error}=await window.supabase.auth.signInWithPassword({email:e,password:this.password});if(error)alert(error.message);else await this.check(data.user.id)},
            async check(uid){const{data}=await window.supabase.from('profiles').select('role').eq('id',uid).single();if(data?.role==='admin'){this.isAdmin=true;this.user=uid;this.loadCats();this.loadStats();this.loadUnread();this.logLogin()}else{alert('éç®¡ç†å‘˜');window.supabase.auth.signOut()}},
            logout(){window.supabase.auth.signOut();location.reload()},
            switchTab(t){this.tab=t;if(t==='list')this.loadResources(0);if(t==='users')this.loadUsers(0);if(t==='msg')this.loadChats();if(t==='keywords')this.loadKeywords(0);if(t==='assoc')this.loadAssoc(0);if(t==='tags')this.loadAllTags()},
            async logLogin(){await window.supabase.from('admin_logs').insert({action:'LOGIN',ip_address:this.stats.ip,user_agent:navigator.userAgent})},
            async loadStats(){const{count:uc}=await window.supabase.from('profiles').select('*',{count:'exact',head:true});this.stats.users=uc;const{count:pc}=await window.supabase.from('resources').select('*',{count:'exact',head:true});this.stats.posts=pc;const{data}=await window.supabase.from('admin_logs').select('*').order('created_at',{ascending:false}).limit(5);this.stats.logs=data||[]},
            async loadUnread(){const{count}=await window.supabase.from('messages').select('*',{count:'exact',head:true}).eq('is_read',false).neq('sender','admin');this.unreadCount=count||0},
            async loadCats(){const{data}=await window.supabase.from('categories').select('*').order('id');this.categories=data||[];if(data){const z=data.find(c=>c.name.includes('ç»¼è‰º'));this.post.category_id=z?z.id:data[0].id}},
            getCatName(id){return this.categories.find(c=>c.id===id)?.name||'æœªåˆ†ç±»'},

            addBlock(){this.post.blocks.push({type:'text',value:'',locked:true})},
            addPostTag(ctx){const target=ctx==='post'?this.post:this.editPostData;if(this.newTag&&!target.tags.some(t=>t.name===this.newTag&&t.type===this.newTagType))target.tags.push({name:this.newTag,type:this.newTagType});this.newTag=''},
            
            // ç»ˆææ—¥æœŸæ­£åˆ™ (å«å¤æ‚æ ¼å¼)
            autoParseDate(ctx){
                const target=ctx==='post'?this.post:this.editPostData; if(target.custom_date)return;
                const t=target.title; let d='';
                // 1. å¹´ä»½èŒƒå›´: 2002-2003, 02-03, 2002å¹´-2003å¹´ -> å–èµ·å§‹å¹´ 2002-01-01
                // å¿…é¡»åœ¨2ä¹‹å‰ï¼Œé˜²æ­¢ 2002-03 (3æœˆ) è¢«è¯¯åˆ¤ï¼Œæˆ–è€… 02-03 è¢«è¯¯åˆ¤
                // è§„åˆ™ï¼šä¸­é—´æ˜¯ - æˆ– è‡³ï¼Œä¸¤è¾¹æ˜¯å¹´ä»½(2æˆ–4ä½)
                let mRange = t.match(/(?:^|[^0-9])(\d{2,4})\s*(?:å¹´)?\s*[-è‡³]\s*(\d{2,4})(?:å¹´)?(?:\D|$)/);
                // åŒºåˆ† "2002-03"(3æœˆ) å’Œ "02-03"(02å¹´åˆ°03å¹´)
                // å¦‚æœæ˜¯ 4ä½-2ä½ï¼Œé€šå¸¸æ˜¯å¹´æœˆã€‚å¦‚æœæ˜¯ 2ä½-2ä½ï¼Œé€šå¸¸æ˜¯å¹´èŒƒå›´ã€‚
                // ç”¨æˆ·è¯´ "02-03" æ˜¯èŒƒå›´ã€‚ "2002-03" æ˜¯å¹´æœˆã€‚
                if(mRange) {
                    let p1=mRange[1], p2=mRange[2];
                    if(p1.length===4 && p2.length<=2) { /* å¯èƒ½æ˜¯å¹´æœˆ,è·³è¿‡äº¤ç»™ä¸‹é¢ */ }
                    else {
                        let y=parseInt(p1); if(y<100) y+=(y<50?2000:1900);
                        d=`${y}-01-01`; target.custom_date=d; return;
                    }
                }

                // 2. å®Œæ•´æ—¥æœŸ/å¹´æœˆ: 2018.01.7, 17/3/12, 2018å¹´2æœˆ3æ—¥, 2002-03
                let mSep = t.match(/(?:^|[^0-9])(\d{2,4})[./\-å¹´](\d{1,2})(?:[./\-æœˆ](\d{1,2}))?/);
                if(mSep) {
                    let y=parseInt(mSep[1]), m=parseInt(mSep[2]), day=mSep[3]?parseInt(mSep[3]):1;
                    if(y<100) y+=(y<50?2000:1900);
                    d=`${y}-${m.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
                } else {
                    // 3. çº¯æ•°å­—: 19990112 (8ä½), 050312 (6ä½)
                    let mPure = t.match(/(?:^|[^0-9])(\d{6,8})(?:\D|$)/);
                    if(mPure) {
                        let s=mPure[1];
                        if(s.length===8) d=`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
                        else if(s.length===6) { let y=parseInt(s.slice(0,2)); d=`${y<50?2000+y:1900+y}-${s.slice(2,4)}-${s.slice(4,6)}`; }
                    } else {
                        // 4. å•ç‹¬å¹´ä»½: 1999, 2005å¹´
                        let mYear = t.match(/(?:^|[^0-9])(\d{4})(?:å¹´|\s|$)/);
                        if(mYear) d=`${mYear[1]}-01-01`;
                    }
                }
                if(d) target.custom_date=d;
            },

            async uploadImg(e,i,ctx){const f=e.target.files[0];if(!f)return;const p=`${Date.now()}_${Math.random().toString(36).slice(2)}.${f.name.split('.').pop()}`;const{data,error}=await window.supabase.storage.from('images').upload(p,f);if(error)return alert('å¤±è´¥');const{data:{publicUrl}}=window.supabase.storage.from('images').getPublicUrl(p);if(ctx==='post')this.post.blocks[i].value=publicUrl;else this.editPostData.blocks[i].value=publicUrl},
            async publish(){
                if(!this.post.title)return alert('æ ‡é¢˜å¿…å¡«');
                const links=this.post.blocks.filter(b=>b.type==='link'&&b.value.trim()!=='');
                if(links.length===0)return alert('å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªé“¾æ¥');
                const d=this.post.custom_date||new Date().toISOString().split('T')[0];
                const{data:res,error}=await window.supabase.from('resources').insert({title:this.post.title,content_json:this.post.blocks,category_id:this.post.category_id,custom_date:d}).select().single();
                if(error)return alert('å¤±è´¥:'+error.message);
                for(const t of this.post.tags){let{data:tag}=await window.supabase.from('tags').select('id').eq('name',t.name).eq('type',t.type).single();if(!tag){const{data:nT}=await window.supabase.from('tags').insert(t).select().single();tag=nT}await window.supabase.from('resource_tags').insert({resource_id:res.id,tag_id:tag.id})}
                alert('å‘å¸ƒæˆåŠŸ');this.post.title='';this.post.custom_date='';this.post.blocks=[{type:'link',value:'',locked:true}];this.post.tags=[];
            },
            async loadResources(p){this.isLoading=true;this.resPage=p;let q=window.supabase.from('resources').select('*',{count:'exact'});if(this.resSearchQ)q=q.ilike('title',`%${this.resSearchQ}%`);const{data,count}=await q.order('created_at',{ascending:false}).range(p*50,(p+1)*50-1);this.resources=data||[];this.resTotal=count;this.resTotalPages=Math.ceil(count/50);this.resources.forEach(r=>r.selected=false);this.isLoading=false},
            goToResPage(){if(this.jumpPage>0&&this.jumpPage<=this.resTotalPages)this.loadResources(this.jumpPage-1)},
            toggleAllRes(){const all=this.resources.every(r=>r.selected);this.resources.forEach(r=>r.selected=!all)},
            async delRes(id){if(confirm('åˆ ?')){await window.supabase.from('resources').delete().eq('id',id);this.loadResources(this.resPage)}},
            async batchDelete(){const ids=this.resources.filter(r=>r.selected).map(r=>r.id);if(ids.length&&confirm(`åˆ  ${ids.length} ä¸ª?`)){await window.supabase.from('resources').delete().in('id',ids);this.loadResources(this.resPage)}},
            async openEditModal(r){const{data:assoc}=await window.supabase.from('view_resource_tags').select('tag_name,tag_type').eq('resource_id',r.id);this.editPostData={...r,blocks:r.content_json||[],tags:assoc?assoc.map(a=>({name:a.tag_name,type:a.tag_type})):[]};this.editModal=true},
            async saveEditPost(){const{error}=await window.supabase.from('resources').update({title:this.editPostData.title,category_id:this.editPostData.category_id,custom_date:this.editPostData.custom_date,content_json:this.editPostData.blocks}).eq('id',this.editPostData.id);await window.supabase.from('resource_tags').delete().eq('resource_id',this.editPostData.id);for(const t of this.editPostData.tags){let{data:tag}=await window.supabase.from('tags').select('id').eq('name',t.name).eq('type',t.type).single();if(!tag){const{data:nT}=await window.supabase.from('tags').insert(t).select().single();tag=nT}await window.supabase.from('resource_tags').insert({resource_id:this.editPostData.id,tag_id:tag.id})}if(error)alert('å¤±è´¥');else{alert('æˆåŠŸ');this.editModal=false;this.loadResources(this.resPage)}},
            
            async loadKeywords(p){this.kwPage=p;let q=window.supabase.from('tag_keywords').select('*,keyword_tag_definitions(tag_name,tag_type)',{count:'exact'});if(this.kwSearchQ)q=q.ilike('keyword',`%${this.kwSearchQ}%`);const{data,count}=await q.range(p*50,(p+1)*50-1).order('created_at',{ascending:false});this.keywords=(data||[]).map(k=>({...k,tags:k.keyword_tag_definitions.map(d=>({name:d.tag_name,type:d.tag_type})),selected:false}));this.kwTotal=count;this.kwTotalPages=Math.ceil(count/50)},
            goToKwPage(){if(this.jumpKwPage>0&&this.jumpKwPage<=this.kwTotalPages)this.loadKeywords(this.jumpKwPage-1)},
            toggleAllKw(){const all=this.keywords.every(k=>k.selected);this.keywords.forEach(k=>k.selected=!all)},
            openAddKeyword(){this.editKwData={id:null,keyword:'',tags:[]};this.kwModal=true},
            editKeyword(k){this.editKwData={id:k.id,keyword:k.keyword,tags:[...k.tags]};this.kwModal=true},
            addRuleToKw(){if(this.kwNewTagName){this.editKwData.tags.push({name:this.kwNewTagName,type:this.kwNewTagType});this.kwNewTagName=''}},
            async saveKeyword(){if(!this.editKwData.keyword)return alert('å¿…å¡«');let kId=this.editKwData.id;if(!kId){const{data,error}=await window.supabase.from('tag_keywords').insert({keyword:this.editKwData.keyword}).select().single();if(error)return alert('å¤±è´¥');kId=data.id}else{await window.supabase.from('tag_keywords').update({keyword:this.editKwData.keyword}).eq('id',kId)}await window.supabase.from('keyword_tag_definitions').delete().eq('keyword_id',kId);for(const t of this.editKwData.tags){await window.supabase.from('keyword_tag_definitions').insert({keyword_id:kId,tag_name:t.name,tag_type:t.type})}alert('æˆåŠŸ');this.kwModal=false;this.loadKeywords(this.kwPage)},
            async batchDelKw(){const ids=this.keywords.filter(k=>k.selected).map(k=>k.id);if(ids.length&&confirm('åˆ ?')){await window.supabase.from('tag_keywords').delete().in('id',ids);this.loadKeywords(this.kwPage)}},

            async loadAssoc(p){this.assocPage=p;let q=window.supabase.from('view_resource_tags').select('*',{count:'exact'});if(this.assocSearch)q=q.or(`resource_title.ilike.%${this.assocSearch}%,tag_name.ilike.%${this.assocSearch}%`);const{data,count}=await q.range(p*50,(p+1)*50-1);this.assocs=data||[];this.assocTotal=count;this.assocTotalPages=Math.ceil(count/50);this.assocs.forEach(a=>a.selected=false)},
            goToAssocPage(){if(this.jumpAssocPage>0&&this.jumpAssocPage<=this.assocTotalPages)this.loadAssoc(this.jumpAssocPage-1)},
            toggleAllAssoc(){const all=this.assocs.every(a=>a.selected);this.assocs.forEach(a=>a.selected=!all)},
            async delAssoc(a){if(confirm('è§£?')){await window.supabase.from('resource_tags').delete().eq('resource_id',a.resource_id).eq('tag_id',a.tag_id);this.loadAssoc(this.assocPage)}},
            async batchDelAssoc(){const sel=this.assocs.filter(a=>a.selected);if(sel.length&&confirm('è§£?')){for(const a of sel)await window.supabase.from('resource_tags').delete().eq('resource_id',a.resource_id).eq('tag_id',a.tag_id);this.loadAssoc(this.assocPage)}},
            openAddAssoc(){this.newAssocData={resource_id:'',tag_name:'',tag_type:'ç•ªç»„'};this.assocModal=true},
            async saveAssoc(){if(!this.newAssocData.resource_id||!this.newAssocData.tag_name)return alert('å¿…å¡«');const{data:res}=await window.supabase.from('resources').select('id').eq('id',this.newAssocData.resource_id).single();if(!res)return alert('å¸–å­IDä¸å­˜åœ¨');let tId;const{data:tag}=await window.supabase.from('tags').select('id').eq('name',this.newAssocData.tag_name).eq('type',this.newAssocData.tag_type).single();if(tag)tId=tag.id;else{const{data:nT}=await window.supabase.from('tags').insert({name:this.newAssocData.tag_name,type:this.newAssocData.tag_type}).select().single();tId=nT.id}const{error}=await window.supabase.from('resource_tags').insert({resource_id:res.id,tag_id:tId});if(error)alert('å¤±è´¥');else{alert('æˆåŠŸ');this.assocModal=false;this.loadAssoc(this.assocPage)}},

            async loadUsers(p){this.userPage=p;let q=window.supabase.from('profiles').select('*').order('created_at',{ascending:false});if(this.userSearchQ)q=q.or(`email.ilike.%${this.userSearchQ}%,username.ilike.%${this.userSearchQ}%`);const{data}=await q.range(p*30,(p+1)*30-1);this.users=data||[];},
            async saveUser(u){const{data,error}=await window.supabase.rpc('admin_update_keys',{target_user_id:u.id,new_keys:parseInt(u.edit_keys)});if(error||!data.success)alert('å¤±è´¥');else{alert('æˆåŠŸ');u.keys_count=u.edit_keys}},
            openPrivilegeModal(u){this.privData={id:u.id,count:u.override_key_count||u.keys_count,start:u.override_start_date||'',end:u.override_end_date||''};this.privModal=true},
            async savePrivilege(){const{data,error}=await window.supabase.rpc('admin_update_override',{target_user_id:this.privData.id,start_date:this.privData.start||null,end_date:this.privData.end||null,lock_keys:parseInt(this.privData.count)});if(error||!data.success)alert('å¤±è´¥');else{alert('è®¾ç½®æˆåŠŸ');this.privModal=false;this.loadUsers(this.userPage)}},
            openDM(u){this.tab='msg';this.activeChat={user_id:u.id,username:u.username||'ç”¨æˆ·'+u.id.slice(0,4)};this.loadChatMsgs()},
            async loadChats(){const{data}=await window.supabase.from('messages').select('*,profiles(username)').neq('sender','admin').order('created_at',{ascending:false});const m=new Map();(data||[]).forEach(x=>{if(!m.has(x.user_id))m.set(x.user_id,{user_id:x.user_id,username:(x.profiles&&x.profiles.username)?x.profiles.username:'æœªçŸ¥ç”¨æˆ·',last_msg:x.content,read:x.is_read})});this.conversations=Array.from(m.values())},
            async loadChatMsgs(){if(!this.activeChat)return;const{data}=await window.supabase.from('messages').select('*').eq('user_id',this.activeChat.user_id).order('created_at',{ascending:true});this.chatMsgs=data||[];setTimeout(()=>document.getElementById('admChatBox').scrollTop=9999,100);await window.supabase.from('messages').update({is_read:true}).eq('user_id',this.activeChat.user_id).eq('sender','user');const c=this.conversations.find(x=>x.user_id===this.activeChat.user_id);if(c&&!c.read){c.read=true;this.unreadCount=Math.max(0,this.unreadCount-1)}},
            async sendAdmMsg(){if(!this.chatInput)return;await window.supabase.from('messages').insert({user_id:this.activeChat.user_id,sender:'admin',content:this.chatInput});this.chatInput='';this.loadChatMsgs()},
            async loadAllTags(){const{data}=await window.supabase.from('tags').select('*').eq('type',this.tagType);this.allTags=data||[]},
            async delTag(id){if(confirm('åˆ ?'))await window.supabase.from('tags').delete().eq('id',id);this.loadAllTags()},
            openEditTag(t){this.editTagData={...t};this.tagModal=true;this.loadTagPosts(t.id)}, 
            async loadTagPosts(tid){this.tagPosts=[];const{data}=await window.supabase.from('view_resource_tags').select('resource_title, resource_date').eq('tag_id',tid).limit(20);if(data)this.tagPosts=data.map(x=>({title:x.resource_title,custom_date:x.resource_date}))},
            async saveEditTag(){const{error}=await window.supabase.from('tags').update({name:this.editTagData.name,type:this.editTagData.type,image_url:this.editTagData.image_url}).eq('id',this.editTagData.id);if(error)alert('å¤±è´¥');else{this.tagModal=false;this.loadAllTags()}},
            async addCat(){if(this.newCatName)await window.supabase.from('categories').insert({name:this.newCatName});this.loadCats()},
            async delCat(id){if(confirm('åˆ ?'))await window.supabase.from('categories').delete().eq('id',id);this.loadCats()},
            async backupData(){const t=['resources','users','tags','resource_tags','categories','profiles','messages','tag_keywords','keyword_tag_definitions'];const b={};for(const x of t){const{data}=await window.supabase.from(x==='users'?'profiles':x).select('*');b[x]=data}const u=URL.createObjectURL(new Blob([JSON.stringify(b)],{type:'application/json'}));const a=document.createElement('a');a.href=u;a.download=`backup_${new Date().toISOString().slice(0,10)}.json`;a.click()},
            async restoreData(){const f=document.getElementById('restoreFile').files[0];if(!f)return;const r=new FileReader();r.onload=async(e)=>{const d=JSON.parse(e.target.result);if(confirm('æ¢å¤?')){if(d.categories)await window.supabase.from('categories').upsert(d.categories);if(d.tags)await window.supabase.from('tags').upsert(d.tags);if(d.resources)await window.supabase.from('resources').upsert(d.resources);if(d.resource_tags)await window.supabase.from('resource_tags').upsert(d.resource_tags);alert('å®Œæˆ')}};r.readAsText(f)}
        }}
    </script>
</body>
</html>
