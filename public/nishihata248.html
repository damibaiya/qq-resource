<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100" x-data="admin()">
    <!-- ç™»å½•ç•¥ -->
    
    <div x-show="token" class="min-h-screen flex flex-col h-screen" x-cloak>
        <nav class="bg-slate-800 text-white p-4 shrink-0 flex justify-between">
            <span class="font-bold">ğŸ‹ è“é²¸ç®¡ç†</span>
            <div class="space-x-1 text-sm flex items-center">
                <button @click="switchTab('post')" :class="tab==='post'?'text-blue-300':''">å‘å¸ƒ</button>
                <button @click="switchTab('list')" :class="tab==='list'?'text-blue-300':''">æ–‡ç« </button>
                <button @click="switchTab('tags')" :class="tab==='tags'?'text-blue-300':''">æ ‡ç­¾</button>
                <button @click="switchTab('keywords')" :class="tab==='keywords'?'text-blue-300':''">å…³è”</button>
                <button @click="switchTab('users')" :class="tab==='users'?'text-blue-300':''">ç”¨æˆ·</button>
                <button @click="switchTab('msgs')" :class="tab==='msgs'?'text-blue-300':''" class="relative">
                    ç§ä¿¡ <span x-show="totalUnread>0" class="absolute -top-1 -right-2 bg-red-500 text-[8px] px-1 rounded-full" x-text="totalUnread"></span>
                </button>
                <button @click="switchTab('cats')" :class="tab==='cats'?'text-blue-300':''">åˆ†ç±»</button>
                <div class="w-px h-4 bg-slate-600 mx-2"></div>
                <button @click="backupData" class="text-green-400">å¤‡ä»½</button>
                <button @click="logout" class="text-red-400 ml-2">é€€å‡º</button>
            </div>
        </nav>

        <main class="flex-1 overflow-hidden p-6">
            <!-- å…¶ä»–æ¨¡å—ä¿æŒä¸å˜ -->
            
            <!-- ç§ä¿¡ç®¡ç† -->
            <div x-show="tab === 'msgs'" class="bg-white rounded shadow h-full flex overflow-hidden border">
                <div class="w-64 border-r flex flex-col bg-gray-50">
                    <div class="p-3 border-b font-bold flex justify-between bg-white"><span>åˆ—è¡¨</span><button @click="loadInbox" class="text-xs text-blue-500">åˆ·æ–°</button></div>
                    <div class="flex-1 overflow-y-auto">
                        <template x-for="u in inboxList" :key="u.id">
                            <div @click="selectChat(u)" class="p-3 border-b cursor-pointer hover:bg-blue-100 relative" :class="activeChatUser?.id===u.id?'bg-blue-200':''">
                                <div class="font-bold text-xs" x-text="u.username"></div>
                                <div class="text-[10px] text-gray-500 truncate" x-text="u.last_msg"></div>
                                <div x-show="u.unread>0" class="absolute top-3 right-3 w-2 h-2 bg-red-500 rounded-full"></div>
                            </div>
                        </template>
                    </div>
                </div>
                <!-- èŠå¤©çª—å£ä¿æŒä¸å˜ -->
            </div>
        </main>
    </div>

    <script>
        function admin() {
            return {
                // ... å…¶ä»–çŠ¶æ€ä¿æŒ ...
                totalUnread: 0,

                async loadInbox() { 
                    const res = await fetch('/api/admin/inbox', { headers:this.auth() }); 
                    if(res.ok) {
                        this.inboxList = await res.json();
                        this.totalUnread = this.inboxList.reduce((sum, u) => sum + (u.unread || 0), 0);
                    }
                },

                async backupData() {
                    if(!confirm('ä¸‹è½½æ‰€æœ‰æ•°æ®å¤‡ä»½?')) return;
                    const res = await fetch('/api/admin/backup', { headers:this.auth() });
                    if(res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                    }
                },
                // ... å…¶ä»–å‡½æ•°ä¿æŒ ...
            }
        }
    </script>
</body>
</html>
