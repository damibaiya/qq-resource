<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸åå°ç®¡ç†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100" x-data="admin()">
    <div x-show="!token" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded shadow w-96"><h1 class="font-bold mb-4">ç™»å½•</h1><input type="text" x-model="loginForm.loginId" class="w-full border p-2 mb-2"><input type="password" x-model="loginForm.password" class="w-full border p-2 mb-4"><button @click="login" class="w-full bg-blue-600 text-white py-2 rounded">Login</button></div>
    </div>

    <div x-show="token" class="min-h-screen flex flex-col h-screen" x-cloak>
        <nav class="bg-slate-800 text-white p-4 shrink-0 flex justify-between items-center">
            <span class="font-bold mr-4">ğŸ‹ è“é²¸ç®¡ç†</span>
            <div class="space-x-1 text-sm flex items-center">
                <button @click="switchTab('post')" :class="tab==='post'?'text-blue-300':''">å‘å¸ƒ</button>
                <button @click="switchTab('list')" :class="tab==='list'?'text-blue-300':''">æ–‡ç« </button>
                <button @click="switchTab('tags')" :class="tab==='tags'?'text-blue-300':''">æ ‡ç­¾</button>
                <button @click="switchTab('keywords')" :class="tab==='keywords'?'text-blue-300':''">å…³è”</button>
                <button @click="switchTab('users')" :class="tab==='users'?'text-blue-300':''">ç”¨æˆ·</button>
                <button @click="switchTab('msgs')" :class="tab==='msgs'?'text-blue-300':''" class="relative">ç§ä¿¡<span x-show="totalUnread>0" class="absolute -top-1 -right-2 bg-red-500 text-[8px] px-1 rounded-full" x-text="totalUnread"></span></button>
                <button @click="switchTab('cats')" :class="tab==='cats'?'text-blue-300':''">åˆ†ç±»</button>
                <div class="w-px h-4 bg-slate-600 mx-2"></div>
                <button @click="backupData" class="text-green-400">å¤‡ä»½</button>
                <button @click="triggerRestore" class="text-red-400 ml-2">æ¢å¤</button>
                <button @click="logout" class="text-gray-400 ml-4">é€€å‡º</button>
            </div>
        </nav>

        <main class="flex-1 overflow-hidden p-6">
            
            <!-- 1. å‘å¸ƒ/ç¼–è¾‘ -->
            <div x-show="tab === 'post'" class="bg-white p-6 rounded shadow h-full overflow-y-auto">
                <div class="space-y-4 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold" x-text="isEdit?'ä¿®æ”¹':'å‘å¸ƒ'"></h2>
                        <span class="text-xs text-red-500">æç¤ºï¼šä¸ºé˜²æ­¢é‡å¤ï¼Œå»ºè®®å‘å¸ƒå‰å…ˆåœ¨â€œæ–‡ç« â€é¡µæœç´¢ä¸€ä¸‹æ ‡é¢˜</span>
                    </div>
                    <input type="text" x-model="post.title" placeholder="æ ‡é¢˜" class="w-full border p-2 rounded">
                    <div class="flex gap-4"><select x-model="post.category_id" class="border p-2 rounded flex-1"><option value="">åˆ†ç±»...</option><template x-for="c in categories" :key="c.id"><option :value="c.id" x-text="c.name"></option></template></select><input type="text" x-model="post.manualDate" placeholder="æ—¥æœŸ" class="border p-2 rounded flex-1"></div>
                    <div class="border p-4 rounded bg-blue-50">
                        <h3 class="text-sm font-bold text-gray-700 mb-2">ğŸ·ï¸ æ ‡ç­¾ (è‡ªåŠ¨å…³è”)</h3>
                        <div class="space-y-2"><template x-for="(t, idx) in post.tags" :key="idx"><div class="flex gap-2 items-center bg-white p-2 rounded border"><select x-model="t.type" class="border p-1 rounded text-xs"><option value="ç•ªç»„">ç•ªç»„</option><option value="è‰ºäºº">è‰ºäºº</option></select><input type="text" x-model="t.name" @blur="autoFillTagImg(idx)" placeholder="æ ‡ç­¾å" class="border p-1 rounded text-sm flex-1"><input type="text" x-model="t.image_url" placeholder="å›¾ç‰‡URL" class="border p-1 rounded text-xs w-1/3"><button @click="post.tags.splice(idx,1)" class="text-red-500">âœ•</button></div></template><button @click="post.tags.push({type:'ç•ªç»„',name:'',image_url:''})" class="text-xs bg-blue-200 px-2 rounded">+æ ‡ç­¾</button></div>
                    </div>
                    <div class="border rounded p-4 bg-gray-50 space-y-2">
                        <template x-for="(block, idx) in post.blocks" :key="idx"><div class="flex gap-2 items-center bg-white p-2 rounded border"><span x-text="idx+1" class="text-xs text-gray-400"></span><select x-model="block.type" class="border text-sm p-1 rounded"><option value="text">æ–‡æœ¬</option><option value="link">é“¾æ¥</option><option value="image">å›¾ç‰‡</option></select><div class="flex-1 space-y-1"><input type="text" x-model="block.value" class="w-full border p-1 rounded text-sm"><div x-show="block.type==='link'" class="flex gap-2 text-xs"><select x-model="block.linkType" class="border p-1 rounded"><option value="å¤¸å…‹">å¤¸å…‹</option><option value="ç™¾åº¦">ç™¾åº¦</option><option value="å…¶ä»–">å…¶ä»–</option></select><input x-show="block.linkType==='å…¶ä»–'" type="text" x-model="block.customLinkType" placeholder="ç±»å‹" class="border p-1 rounded w-20"></div><input x-show="block.type==='image'" type="file" @change="uploadImg($event, idx)" class="text-xs"></div><label class="flex items-center gap-1 text-xs bg-gray-100 p-1 rounded"><input type="checkbox" x-model="block.locked">ğŸ”’</label><button @click="post.blocks.splice(idx,1)" class="text-red-500">âœ•</button></div></template>
                        <div class="flex gap-2"><button @click="addBlock('text')" class="text-xs bg-gray-200 px-2 rounded">+æ–‡</button><button @click="addBlock('link')" class="text-xs bg-gray-200 px-2 rounded">+é“¾</button><button @click="addBlock('image')" class="text-xs bg-gray-200 px-2 rounded">+å›¾</button></div>
                    </div>
                    <button @click="publish" class="w-full bg-blue-600 text-white py-2 rounded">æäº¤</button>
                </div>
            </div>

            <!-- 2. æ–‡ç« åˆ—è¡¨ (å¢åŠ ä¸€é”®å»é‡) -->
            <div x-show="tab === 'list'" class="bg-white p-6 rounded shadow h-full overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex gap-2"><select x-model="filterCatId" @change="page=1;loadResources()" class="border p-2 rounded"><option value="">å…¨éƒ¨åˆ†ç±»</option><template x-for="c in categories" :key="c.id"><option :value="c.id" x-text="c.name"></option></template></select><input type="text" x-model="searchQ" class="border p-2 rounded w-40" placeholder="æœæ ‡é¢˜"><button @click="page=1;loadResources()" class="bg-blue-600 text-white px-4 rounded">æœ</button></div>
                    <div class="flex gap-2">
                        <button @click="deduplicate" class="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600 transition">ğŸ§¹ ä¸€é”®å»é‡ (ä¿ç•™æœ€æ–°)</button>
                        <button x-show="selectedPosts.length > 0" @click="batchDeletePosts" class="bg-red-500 text-white px-3 py-1 rounded text-sm">æ‰¹é‡åˆ é™¤ (<span x-text="selectedPosts.length"></span>)</button>
                    </div>
                </div>
                <table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th class="p-3"><input type="checkbox" @change="toggleAllPosts($event)"></th><th>ID</th><th>æ ‡é¢˜</th><th>åˆ†ç±»</th><th>æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
                <tbody><template x-for="r in resourceList" :key="r.id"><tr class="border-b"><td class="p-3"><input type="checkbox" :value="r.id" x-model="selectedPosts"></td><td class="p-2" x-text="r.id"></td><td x-text="r.title"></td><td x-text="getCatName(r.category_id)"></td><td x-text="r.custom_date"></td><td><button @click="editResource(r.id)" class="text-blue-600 mr-2">æ”¹</button><button @click="delResource(r.id)" class="text-red-600">åˆ </button></td></tr></template></tbody></table>
                <div class="flex justify-center gap-4 mt-4 text-sm items-center"><button @click="prevPage" :disabled="page===1" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">ä¸Šä¸€é¡µ</button><span>ç¬¬ <span x-text="page"></span> é¡µ</span><button @click="nextPage" class="px-3 py-1 bg-gray-200 rounded">ä¸‹ä¸€é¡µ</button></div>
            </div>

            <!-- å…¶ä»–ä¿æŒä¸å˜ -->
            <div x-show="tab === 'tags'" class="bg-white p-6 rounded shadow h-full overflow-y-auto"><div x-show="editingTag" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded"><h3 class="font-bold text-yellow-700 mb-2">âœï¸ ç¼–è¾‘æ ‡ç­¾</h3><div class="flex gap-2 items-center mb-2"><select x-model="editingTag.type" class="border p-2 rounded text-sm"><option value="ç•ªç»„">ç•ªç»„</option><option value="è‰ºäºº">è‰ºäºº</option></select><input type="text" x-model="editingTag.name" class="border p-2 rounded text-sm flex-1"><input type="text" x-model="editingTag.image_url" class="border p-2 rounded text-sm flex-1"><div class="relative"><input type="file" @change="uploadTagImg" class="absolute inset-0 opacity-0 cursor-pointer"><button class="bg-gray-200 px-3 py-2 rounded text-sm border">ä¸Šä¼ å›¾</button></div></div><div class="flex gap-2"><button @click="updateTag" class="bg-blue-600 text-white px-4 py-1 rounded text-sm">ä¿å­˜</button><button @click="editingTag=null; tagPosts=[]" class="text-gray-500 text-sm">å–æ¶ˆ</button></div></div><div class="flex justify-between items-center mb-6"><h2 class="text-lg font-bold">æ ‡ç­¾åˆ—è¡¨</h2></div><div class="mb-6"><h3 class="font-bold text-purple-600 mb-2">ğŸ“º ç•ªç»„æ ‡ç­¾</h3><div class="flex flex-wrap gap-3"><template x-for="t in allTags.filter(x=>x.type==='ç•ªç»„')" :key="t.id"><div @click="loadTagPosts(t)" class="border p-2 rounded cursor-pointer hover:bg-purple-50 flex items-center gap-2" :class="editingTag?.id===t.id?'ring-2 ring-purple-300':''"><img :src="t.image_url||'https://via.placeholder.com/30'" class="w-8 h-8 rounded object-cover"><div><div class="font-bold text-sm" x-text="t.name"></div><div class="text-[10px] text-gray-400" x-text="t.post_count+' å¸–'"></div></div></div></template></div></div><div class="mb-6"><h3 class="font-bold text-pink-600 mb-2">ğŸ¤ è‰ºäººæ ‡ç­¾</h3><div class="flex flex-wrap gap-3"><template x-for="t in allTags.filter(x=>x.type==='è‰ºäºº')" :key="t.id"><div @click="loadTagPosts(t)" class="border p-2 rounded cursor-pointer hover:bg-pink-50 flex items-center gap-2" :class="editingTag?.id===t.id?'ring-2 ring-pink-300':''"><img :src="t.image_url||'https://via.placeholder.com/30'" class="w-8 h-8 rounded object-cover"><div><div class="font-bold text-sm" x-text="t.name"></div><div class="text-[10px] text-gray-400" x-text="t.post_count+' å¸–'"></div></div></div></template></div></div><div x-show="tagPosts.length > 0" class="border-t pt-4"><h3 class="font-bold mb-2">å…³è”å¸–å­:</h3><table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th>ID</th><th>æ ‡é¢˜</th><th>æ“ä½œ</th></tr></thead><tbody><template x-for="r in tagPosts" :key="r.id"><tr class="border-b"><td class="p-2" x-text="r.id"></td><td x-text="r.title"></td><td><button @click="editResource(r.id)" class="text-blue-600">ä¿®æ”¹</button></td></tr></template></tbody></table></div></div>
            <div x-show="tab === 'keywords'" class="bg-white p-6 rounded shadow h-full overflow-y-auto"><h2 class="text-lg font-bold mb-4">è‡ªåŠ¨å…³è”è§„åˆ™</h2><div class="flex gap-2 mb-4 p-4 bg-gray-50 rounded"><input type="text" x-model="newKw.keyword" placeholder="å…³é”®è¯" class="border p-2 rounded text-sm"><input type="text" x-model="newKw.tagName" placeholder="æ ‡ç­¾å" class="border p-2 rounded text-sm"><select x-model="newKw.tagType" class="border p-2 rounded text-sm"><option value="è‰ºäºº">è‰ºäºº</option><option value="ç•ªç»„">ç•ªç»„</option></select><button @click="addKeyword" class="bg-green-600 text-white px-4 rounded text-sm">æ·»åŠ </button></div><table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th>å…³é”®è¯</th><th>è‡ªåŠ¨å…³è”æ ‡ç­¾</th><th>æ“ä½œ</th></tr></thead><tbody><template x-for="k in keywords" :key="k.id"><tr class="border-b"><td class="p-3 font-bold" x-text="k.keyword"></td><td x-text="k.tag_name + ' (' + k.tag_type + ')'"></td><td><button @click="delKeyword(k.id)" class="text-red-500">åˆ </button></td></tr></template></tbody></table></div>
            
            <!-- 5. ç”¨æˆ·ç®¡ç† (æ˜¾ç¤ºè¿ç»­ç­¾åˆ°å¤©æ•°) -->
            <div x-show="tab === 'users'" class="bg-white p-6 rounded shadow h-full overflow-y-auto">
                <div class="flex justify-between items-center mb-4"><div class="flex gap-2"><button @click="loadUsers" class="text-sm text-blue-500">åˆ·æ–°</button><button @click="showBlacklist=true; loadBlacklist()" class="text-xs bg-gray-800 text-white px-3 py-1 rounded">é»‘åå•</button></div><div class="flex gap-2" x-show="selectedUsers.length>0"><button @click="batchAction('mute')" class="bg-yellow-100 text-xs px-2 rounded">ç¦è¨€</button><button @click="batchAction('unmute')" class="bg-green-100 text-xs px-2 rounded">è§£ç¦</button><button @click="batchAction('delete')" class="bg-red-100 text-xs px-2 rounded">åˆ é™¤</button><button @click="batchAction('ban')" class="bg-black text-white text-xs px-2 rounded">æ°¸ä¹…æ‹‰é»‘</button></div></div>
                <table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th class="p-3"><input type="checkbox" @change="toggleAll($event)"></th><th>ID</th><th>ç”¨æˆ·</th><th>é‚®ç®±</th><th>è¿ç»­ç­¾åˆ°</th><th>çŠ¶æ€</th><th>é’¥åŒ™</th><th>æ“ä½œ</th></tr></thead>
                <tbody><template x-for="u in users" :key="u.id"><tr class="border-b hover:bg-gray-50">
                    <td class="p-3"><input type="checkbox" :value="u.id" x-model="selectedUsers"></td>
                    <td x-text="u.id"></td><td x-text="u.username"></td><td x-text="u.email"></td>
                    <td class="text-center font-mono text-blue-600" x-text="u.consecutive_days + ' å¤©'"></td>
                    <td><span x-show="u.is_muted" class="text-red-500 font-bold">ç¦è¨€</span><span x-show="!u.is_muted" class="text-green-500">æ­£å¸¸</span></td>
                    <td x-text="(u.daily_limit||1)"></td>
                    <td><button @click="editQuota(u)" class="text-blue-600">è®¾ç½®</button></td>
                </tr></template></tbody></table>
                <div x-show="showBlacklist" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded w-96 max-h-[80vh] overflow-y-auto"><div class="flex justify-between mb-4"><h3 class="font-bold">é»‘åå•</h3><button @click="showBlacklist=false">âœ•</button></div><div class="space-y-2"><template x-for="b in blacklist" :key="b.email"><div class="flex justify-between bg-gray-50 p-2 rounded text-xs"><span x-text="b.email"></span><button @click="unban(b.email)" class="text-red-500">è§£å°</button></div></template></div></div></div>
            </div>
            
            <!-- 6. ç§ä¿¡ -->
            <div x-show="tab === 'msgs'" class="bg-white rounded shadow h-full flex overflow-hidden border"><div class="w-64 border-r flex flex-col bg-gray-50"><div class="p-3 border-b font-bold bg-white flex justify-between"><span>ç§ä¿¡</span><button @click="loadInbox" class="text-xs text-blue-500">åˆ·æ–°</button></div><div class="flex-1 overflow-y-auto"><template x-for="u in inboxList" :key="u.id"><div @click="selectChat(u)" class="p-3 border-b cursor-pointer hover:bg-blue-100 relative" :class="activeChatUser?.id===u.id?'bg-blue-200':''"><div class="font-bold text-xs" x-text="u.username"></div><div class="text-[10px] text-gray-500 truncate" x-text="u.last_msg"></div><div x-show="u.unread>0" class="absolute top-3 right-3 w-2 h-2 bg-red-500 rounded-full"></div></div></template></div></div><div class="flex-1 flex flex-col bg-white"><div x-show="activeChatUser" class="flex-1 flex flex-col h-full relative"><div class="p-3 border-b bg-gray-50 font-bold" x-text="activeChatUser?.username"></div><div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" id="adminChatContainer"><template x-for="msg in currentChatMsgs" :key="msg.id"><div class="flex flex-col" :class="msg.sender==='admin'?'items-end':'items-start'"><div class="max-w-[80%] p-2 rounded text-xs" :class="msg.sender==='admin'?'bg-blue-600 text-white':'bg-white border'"><div x-text="msg.content"></div></div></div></template></div><div class="p-3 bg-white border-t flex gap-2"><input type="text" x-model="replyContent" @keyup.enter="sendReply" class="flex-1 border p-2 rounded text-sm outline-none"><button @click="sendReply" class="bg-blue-600 text-white px-4 rounded text-sm">å‘</button></div></div></div></div>
            <!-- 7. åˆ†ç±» -->
            <div x-show="tab === 'cats'" class="bg-white p-6 rounded shadow max-w-lg mx-auto mt-10"><div class="flex gap-2 mb-4"><input type="text" x-model="newCat" class="border p-2 flex-1 rounded"><button @click="manageCat('add')" class="bg-green-500 text-white px-4 rounded">æ·»åŠ </button></div><div class="space-y-2"><template x-for="c in categories" :key="c.id"><div class="flex justify-between border p-2 rounded"><span x-text="c.name"></span><button @click="manageCat('del', c.id)" class="text-red-500">åˆ </button></div></template></div></div>
        </main>
        <input type="file" id="restoreInput" style="display:none" @change="handleRestore">
    </div>

    <script>
        function admin() {
            return {
                token: localStorage.getItem('adm_token') || '', tab: 'post', isEdit: false,
                loginForm: { loginId: '', password: '' }, categories: [], resourceList: [], users: [], blacklist: [], searchQ: '', filterCatId: '',
                post: { id: null, title: '', category_id: 3, blocks: [], manualDate: '', tags: [] },
                newCat: '', allTags: [], tagPosts: [], editingTag: null, keywords: [], newKw: {keyword:'', tagName:'', tagType:'è‰ºäºº'},
                inboxList: [], activeChatUser: null, currentChatMsgs: [], replyContent: '', selectedUsers: [], selectedPosts: [], showBlacklist: false,
                totalUnread: 0, page: 1,

                async init() { if(this.token) { try{ await this.loadCats(); await this.loadResources(); await this.loadInbox(); }catch(e){} } },
                async login() { const res = await fetch('/api/auth/login', {method:'POST', body:JSON.stringify({...this.loginForm, isAdmin:true})}); const data = await res.json(); if(res.ok) { this.token = data.token; localStorage.setItem('adm_token', data.token); location.reload(); } else alert(data.error); },
                logout() { this.token=''; localStorage.removeItem('adm_token'); location.reload(); },
                auth() { return {'Authorization': `Bearer ${this.token}`}; },
                
                switchTab(t) { 
                    this.tab = t; 
                    if(t==='post') this.resetPost(); 
                    if(t==='list') { this.page=1; this.loadResources(); }
                    if(t==='tags') this.loadAllTags();
                    if(t==='keywords') this.loadKeywords();
                    if(t==='users') this.loadUsers();
                    if(t==='msgs') this.loadInbox();
                },

                // èµ„æº
                async loadCats() { this.categories = (await (await fetch('/api/public/home')).json()).categories; },
                async loadResources() { let url = `/api/admin/resources?page=${this.page}&q=${this.searchQ}`; if(this.filterCatId) url+=`&catId=${this.filterCatId}`; const res = await fetch(url, {headers:this.auth()}); this.resourceList = await res.json(); },
                prevPage() { if(this.page>1){ this.page--; this.loadResources(); } },
                nextPage() { this.page++; this.loadResources(); },
                getCatName(id) { const c = this.categories.find(cat => cat.id == id); return c ? c.name : 'æœªåˆ†ç±»'; },
                async editResource(id) { const res = await fetch(`/api/admin/resource/${id}`, {headers:this.auth()}); const data = await res.json(); this.post={id:data.id, title:data.title, category_id:data.category_id, blocks:JSON.parse(data.content_json||'[]'), manualDate:data.custom_date, tags:data.tags||[]}; if(this.post.tags.length===0) this.post.tags.push({type:'ç•ªç»„',name:'',image_url:''}); this.isEdit=true; this.tab='post'; },
                async publish() { const hasLink = this.post.blocks.some(b => b.type === 'link' && b.value && b.value.trim() !== ''); if (!hasLink) return alert('è‡³å°‘å¡«å†™ä¸€æ¡æœ‰æ•ˆé“¾æ¥ï¼'); this.post.blocks.forEach(b => { if(b.type==='link' && b.linkType==='å…¶ä»–') b.linkType = b.customLinkType; }); const res = await fetch('/api/admin/resource', {method:'POST', headers:this.auth(), body:JSON.stringify(this.post)}); if(res.ok) { alert('æˆåŠŸ'); this.tab='list'; this.loadResources(); this.resetPost(); } else alert((await res.json()).error); },
                async autoFillTagImg(idx) { const t=this.post.tags[idx]; if(!t.name) return; const res=await fetch(`/api/public/tag-image?name=${t.name}&type=${t.type}`); const d=await res.json(); if(d.imageUrl && !t.image_url) t.image_url=d.imageUrl; },
                addBlock(type) { this.post.blocks.push({ type, value: '', locked: type === 'link', linkType: 'å¤¸å…‹' }); },
                resetPost() { this.post = { id: null, title: '', category_id: 3, blocks: [{type:'link', value:'', locked:true, linkType:'å¤¸å…‹'}], manualDate: '', tags: [{type:'ç•ªç»„', name:'', image_url:''}] }; this.isEdit = false; },
                async uploadImg(e, idx) { const f = e.target.files[0]; if(!f) return; const fd = new FormData(); fd.append('file', f); try { const res = await fetch('/api/admin/upload', {method:'POST', headers:this.auth(), body:fd}); const d = await res.json(); if(d.url) this.post.blocks[idx].value = d.url; } catch(e){} },
                
                async loadAllTags() { const res = await fetch('/api/admin/tags/all', {headers:this.auth()}); this.allTags = await res.json(); this.tagPosts = []; this.editingTag = null; },
                async loadTagPosts(t) { this.editingTag = JSON.parse(JSON.stringify(t)); const res = await fetch(`/api/admin/resources?tagId=${t.id}`, {headers:this.auth()}); this.tagPosts = await res.json(); },
                async updateTag() { if(!this.editingTag) return; if(!this.editingTag.name) return alert('å¿…å¡«'); const res = await fetch('/api/admin/tag/update', {method:'POST', headers:this.auth(), body:JSON.stringify(this.editingTag)}); const data = await res.json(); if(res.ok) { alert(data.message || 'æˆåŠŸ'); this.loadAllTags(); } else alert(data.error); },
                async uploadTagImg(e) { const f = e.target.files[0]; if(!f) return; const fd = new FormData(); fd.append('file', f); try { const res = await fetch('/api/admin/upload', {method:'POST', headers:this.auth(), body:fd}); const d = await res.json(); if(d.url) this.editingTag.image_url = d.url; } catch(e){ alert('å¤±è´¥'); } },

                async loadKeywords() { const res = await fetch('/api/admin/tag-keywords', {headers:this.auth()}); this.keywords = await res.json(); },
                async addKeyword() { if(!this.newKw.keyword || !this.newKw.tagName) return; await fetch('/api/admin/tag-keywords', {method:'POST', headers:this.auth(), body:JSON.stringify({...this.newKw, action:'add'})}); this.newKw.keyword=''; this.loadKeywords(); },
                async delKeyword(id) { if(!confirm('åˆ ?')) return; await fetch('/api/admin/tag-keywords', {method:'POST', headers:this.auth(), body:JSON.stringify({id, action:'del'})}); this.loadKeywords(); },
                
                async loadUsers() { const res = await fetch('/api/admin/users', { headers:this.auth() }); if(res.ok) this.users = await res.json(); },
                toggleAll(e) { this.selectedUsers = e.target.checked ? this.users.map(u => u.id) : []; },
                async batchAction(action) { if(!confirm(`ç¡®è®¤ ${action}?`)) return; await fetch('/api/admin/users/batch', { method:'POST', headers:this.auth(), body:JSON.stringify({ userIds: this.selectedUsers, action }) }); this.loadUsers(); },
                async editQuota(u) { const l = prompt('é’¥åŒ™æ•°:', u.daily_limit||1); if(l) await fetch('/api/admin/user/quota', { method:'POST', headers:this.auth(), body:JSON.stringify({ userId:u.id, config:{limit:parseInt(l)} }) }); this.loadUsers(); },
                async loadBlacklist() { const res = await fetch('/api/admin/blacklist', { headers:this.auth() }); if(res.ok) this.blacklist = await res.json(); },
                async unban(email) { if(!confirm('è§£å°?')) return; await fetch('/api/admin/blacklist/delete', { method:'POST', headers:this.auth(), body:JSON.stringify({email}) }); this.loadBlacklist(); },

                async loadInbox() { const res = await fetch('/api/admin/inbox', { headers:this.auth() }); if(res.ok) { this.inboxList = await res.json(); this.totalUnread = this.inboxList.reduce((sum,u)=>sum+(u.unread||0),0); } },
                async selectChat(u) { this.activeChatUser = u; const res = await fetch(`/api/admin/messages/${u.id}`, { headers:this.auth() }); if(res.ok) { this.currentChatMsgs = await res.json(); this.$nextTick(() => { const c = document.getElementById('adminChatContainer'); if(c) c.scrollTop = c.scrollHeight; }); } },
                async sendReply() { if(!this.replyContent) return; const res = await fetch('/api/admin/message/reply', { method: 'POST', headers: this.auth(), body: JSON.stringify({ userId: this.activeChatUser.id, content: this.replyContent }) }); if(res.ok) { this.replyContent = ''; this.selectChat(this.activeChatUser); } },
                
                async backupData() { if(!confirm('ä¸‹è½½å¤‡ä»½?')) return; const res = await fetch('/api/admin/backup', { headers:this.auth() }); if(res.ok) { const blob = await res.blob(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); } },
                triggerRestore() { document.getElementById('restoreInput').click(); },
                async handleRestore(e) {
                    const file = e.target.files[0]; if(!file) return;
                    if(!confirm('âš ï¸ è­¦å‘Šï¼šè¦†ç›–æ‰€æœ‰æ•°æ®ï¼')) return;
                    const reader = new FileReader();
                    reader.onload = async (evt) => {
                        try {
                            const json = JSON.parse(evt.target.result);
                            const res = await fetch('/api/admin/restore', {method:'POST', headers:this.auth(), body:JSON.stringify(json)});
                            if(res.ok) { alert('æ¢å¤æˆåŠŸï¼Œåˆ·æ–°é¡µé¢'); location.reload(); } else alert('å¤±è´¥: '+(await res.json()).error);
                        } catch(err) { alert('æ–‡ä»¶é”™è¯¯'); }
                    };
                    reader.readAsText(file); e.target.value = '';
                },

                async delResource(id) { if(confirm('åˆ ?')) { await fetch('/api/admin/resource/delete', {method:'POST', headers:this.auth(), body:JSON.stringify({id})}); this.loadResources(); } },
                
                // ä¸€é”®å»é‡é€»è¾‘
                async deduplicate() {
                    if(!confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ã€æ ‡é¢˜å®Œå…¨é‡å¤ã€‘çš„æ—§å¸–å­ï¼Œåªä¿ç•™å‘å¸ƒæ—¶é—´æœ€æ–°çš„ä¸€ç¯‡ã€‚\n\næ“ä½œä¸å¯é€†ï¼Œå»ºè®®å…ˆå¤‡ä»½æ•°æ®ã€‚\n\nç¡®å®šæ‰§è¡Œå—ï¼Ÿ')) return;
                    const res = await fetch('/api/admin/resource/deduplicate', { method: 'POST', headers: this.auth() });
                    const data = await res.json();
                    if(res.ok) { alert(`å»é‡å®Œæˆï¼Œå…±åˆ é™¤äº† ${data.deleted} ç¯‡é‡å¤å¸–å­ã€‚`); this.loadResources(); }
                    else alert('å¤±è´¥');
                },

                // æ‰¹é‡åˆ é™¤
                toggleAllPosts(e) { this.selectedPosts = e.target.checked ? this.resourceList.map(r => r.id) : []; },
                async batchDeletePosts() {
                    if(this.selectedPosts.length === 0) return;
                    if(!confirm(`ç¡®å®šåˆ é™¤è¿™ ${this.selectedPosts.length} ç¯‡å¸–å­å—ï¼Ÿ`)) return;
                    const res = await fetch('/api/admin/resource/delete/batch', { method: 'POST', headers: this.auth(), body: JSON.stringify({ ids: this.selectedPosts }) });
                    if(res.ok) { alert('åˆ é™¤æˆåŠŸ'); this.selectedPosts = []; this.loadResources(); }
                    else alert('åˆ é™¤å¤±è´¥');
                },

                async manageCat(a, id) { if(a==='add'&&!this.newCat) return; await fetch('/api/admin/category', {method:'POST', headers:this.auth(), body:JSON.stringify({action:a, name:this.newCat, id})}); this.newCat=''; this.loadCats(); }
            }
        }
    </script>
</body>
</html>
